

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyomo.contrib.pynumero.interfaces.pyomo_nlp &mdash; Pyomo 6.5.1.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/clipboard.min.js"></script>
        <script src="../../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> Pyomo
          

          
          </a>

          
            
            
              <div class="version">
                6.5.1.dev0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../citing_pyomo.html">Citing Pyomo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyomo_overview/index.html">Pyomo Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pyomo_modeling_components/index.html">Pyomo Modeling Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../solving_pyomo_models.html">Solving Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_models.html">Working with Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_abstractmodels/index.html">Working with Abstract Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../model_transformations/index.html">Model Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modeling_extensions/index.html">Modeling Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial_examples.html">Pyomo Tutorial Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../model_debugging/index.html">Debugging Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../advanced_topics/index.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../errors.html">Common Warnings/Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_reference/index.html">Developer Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../library_reference/index.html">Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contribution_guide.html">Contributing to Pyomo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributed_packages/index.html">Third-Party Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../related_packages.html">Related Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../bibliography.html">Bibliography</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pyomo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>pyomo.contrib.pynumero.interfaces.pyomo_nlp</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyomo.contrib.pynumero.interfaces.pyomo_nlp</h1><div class="highlight"><pre>
<span></span><span class="c1">#  ___________________________________________________________________________</span>
<span class="c1">#</span>
<span class="c1">#  Pyomo: Python Optimization Modeling Objects</span>
<span class="c1">#  Copyright (c) 2008-2022</span>
<span class="c1">#  National Technology and Engineering Solutions of Sandia, LLC</span>
<span class="c1">#  Under the terms of Contract DE-NA0003525 with National Technology and</span>
<span class="c1">#  Engineering Solutions of Sandia, LLC, the U.S. Government retains certain</span>
<span class="c1">#  rights in this software.</span>
<span class="c1">#  This software is distributed under the 3-clause BSD License.</span>
<span class="c1">#  ___________________________________________________________________________</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the classes that provide an NLP interface based on</span>
<span class="sd">the Ampl Solver Library (ASL) implementation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">from</span> <span class="nn">pyomo.common.deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">pyomo.common.tempfiles</span> <span class="kn">import</span> <span class="n">TempfileManager</span>
<span class="kn">from</span> <span class="nn">pyomo.opt</span> <span class="kn">import</span> <span class="n">WriterFactory</span>
<span class="kn">import</span> <span class="nn">pyomo.core.base</span> <span class="k">as</span> <span class="nn">pyo</span>
<span class="kn">from</span> <span class="nn">pyomo.common.collections</span> <span class="kn">import</span> <span class="n">ComponentMap</span>
<span class="kn">from</span> <span class="nn">pyomo.common.env</span> <span class="kn">import</span> <span class="n">CtypesEnviron</span>
<span class="kn">from</span> <span class="nn">..sparse.block_matrix</span> <span class="kn">import</span> <span class="n">BlockMatrix</span>
<span class="kn">from</span> <span class="nn">pyomo.contrib.pynumero.interfaces.ampl_nlp</span> <span class="kn">import</span> <span class="n">AslNLP</span>
<span class="kn">from</span> <span class="nn">pyomo.contrib.pynumero.interfaces.nlp</span> <span class="kn">import</span> <span class="n">NLP</span>
<span class="kn">from</span> <span class="nn">.external_grey_box</span> <span class="kn">import</span> <span class="n">ExternalGreyBoxBlock</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PyomoNLP&#39;</span><span class="p">]</span>


<span class="c1"># TODO: There are todos in the code below</span>
<div class="viewcode-block" id="PyomoNLP"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP">[docs]</a><span class="k">class</span> <span class="nc">PyomoNLP</span><span class="p">(</span><span class="n">AslNLP</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_model</span><span class="p">,</span> <span class="n">nl_file_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pyomo nonlinear program interface</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_model: pyomo.environ.ConcreteModel</span>
<span class="sd">            Pyomo concrete model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TempfileManager</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get the temp file names for the nl file</span>
            <span class="n">nl_file</span> <span class="o">=</span> <span class="n">TempfileManager</span><span class="o">.</span><span class="n">create_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;pynumero.nl&#39;</span><span class="p">)</span>

            <span class="c1"># The current AmplInterface code only supports a single</span>
            <span class="c1"># objective function Therefore, we throw an error if there</span>
            <span class="c1"># is not one (and only one) active objective function. This</span>
            <span class="c1"># is better than adding a dummy objective that the user does</span>
            <span class="c1"># not know about (since we do not have a good place to</span>
            <span class="c1"># remove this objective later)</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: extend the AmplInterface and the AslNLP to correctly</span>
            <span class="c1"># handle this</span>
            <span class="c1">#</span>
            <span class="c1"># This currently addresses issue #1217</span>
            <span class="n">objectives</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">pyomo_model</span><span class="o">.</span><span class="n">component_data_objects</span><span class="p">(</span>
                    <span class="n">ctype</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">descend_into</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;The ASL interface and PyomoNLP in PyNumero currently &#39;</span>
                    <span class="s1">&#39;only support single objective problems. Deactivate &#39;</span>
                    <span class="s1">&#39;any extra objectives you may have, or add a dummy &#39;</span>
                    <span class="s1">&#39;objective (f(x)=0) if you have a square problem &#39;</span>
                    <span class="s1">&#39;(found </span><span class="si">%s</span><span class="s1"> objectives).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">),)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_objective</span> <span class="o">=</span> <span class="n">objectives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># write the nl file for the Pyomo model and get the symbolMap</span>
            <span class="k">if</span> <span class="n">nl_file_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nl_file_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">fname</span><span class="p">,</span> <span class="n">symbolMap</span> <span class="o">=</span> <span class="n">WriterFactory</span><span class="p">(</span><span class="s1">&#39;nl&#39;</span><span class="p">)(</span>
                <span class="n">pyomo_model</span><span class="p">,</span> <span class="n">nl_file</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">nl_file_options</span>
            <span class="p">)</span>

            <span class="c1"># create component maps from vardata to idx and condata to idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span> <span class="o">=</span> <span class="n">vdidx</span> <span class="o">=</span> <span class="n">ComponentMap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span> <span class="o">=</span> <span class="n">cdidx</span> <span class="o">=</span> <span class="n">ComponentMap</span><span class="p">()</span>

            <span class="c1"># TODO: Are these names totally consistent?</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">symbolMap</span><span class="o">.</span><span class="n">bySymbol</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
                    <span class="n">vdidx</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">cdidx</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="c1"># The NL writer advertises the external function libraries</span>
            <span class="c1"># through the PYOMO_AMPLFUNC environment variable; merge it</span>
            <span class="c1"># with any preexisting AMPLFUNC definitions</span>
            <span class="n">amplfunc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AMPLFUNC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYOMO_AMPLFUNC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">CtypesEnviron</span><span class="p">(</span><span class="n">AMPLFUNC</span><span class="o">=</span><span class="n">amplfunc</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">PyomoNLP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">nl_file</span><span class="p">)</span>

            <span class="c1"># keep pyomo model in cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span> <span class="o">=</span> <span class="n">pyomo_model</span>

            <span class="c1"># Create ComponentMap corresponding to equality constraint indices</span>
            <span class="c1"># This must be done after the call to super-init.</span>
            <span class="n">full_to_equality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con_full_eq_map</span>
            <span class="n">equality_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con_full_eq_mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_eq_idx</span> <span class="o">=</span> <span class="n">ComponentMap</span><span class="p">(</span>
                <span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">full_to_equality</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">con</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">equality_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">full_to_inequality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con_full_ineq_map</span>
            <span class="n">inequality_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_con_full_ineq_mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_ineq_idx</span> <span class="o">=</span> <span class="n">ComponentMap</span><span class="p">(</span>
                <span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">full_to_inequality</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">con</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">inequality_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># delete the nl file</span>
            <span class="n">TempfileManager</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<div class="viewcode-block" id="PyomoNLP.pyomo_model"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.pyomo_model">[docs]</a>    <span class="k">def</span> <span class="nf">pyomo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return optimization model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span></div>

<div class="viewcode-block" id="PyomoNLP.get_pyomo_objective"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_pyomo_objective">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of the active objective function on the Pyomo model.</span>
<span class="sd">        (there can be only one)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective</span></div>

<div class="viewcode-block" id="PyomoNLP.get_pyomo_variables"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_pyomo_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo VarData objects in</span>
<span class="sd">        the order corresponding to the primals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ToDo: is there a more efficient way to do this</span>
        <span class="n">idx_to_vardata</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx_to_vardata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_to_vardata</span><span class="p">))]</span></div>

<div class="viewcode-block" id="PyomoNLP.get_pyomo_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_pyomo_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData objects in</span>
<span class="sd">        the order corresponding to the primals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ToDo: is there a more efficient way to do this</span>
        <span class="n">idx_to_condata</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx_to_condata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_to_condata</span><span class="p">))]</span></div>

<div class="viewcode-block" id="PyomoNLP.get_pyomo_equality_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_pyomo_equality_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_equality_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData objects in</span>
<span class="sd">        the order corresponding to the equality constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx_to_condata</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_eq_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx_to_condata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_to_condata</span><span class="p">))]</span></div>

<div class="viewcode-block" id="PyomoNLP.get_pyomo_inequality_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_pyomo_inequality_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_inequality_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData objects in</span>
<span class="sd">        the order corresponding to the inequality constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx_to_condata</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_ineq_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx_to_condata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_to_condata</span><span class="p">))]</span></div>

<div class="viewcode-block" id="PyomoNLP.variable_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.variable_names">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span>
        <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;This method has been replaced with primals_names&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;6.0.0.dev0&#39;</span><span class="p">,</span>
        <span class="n">remove_in</span><span class="o">=</span><span class="s1">&#39;6.0&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">variable_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primals_names</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyomoNLP.primals_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.primals_names">[docs]</a>    <span class="k">def</span> <span class="nf">primals_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo variable</span>
<span class="sd">        names in the order corresponding to the primals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pyomo_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pyomo_variables</span><span class="p">]</span></div>

<div class="viewcode-block" id="PyomoNLP.constraint_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.constraint_names">[docs]</a>    <span class="k">def</span> <span class="nf">constraint_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo constraint</span>
<span class="sd">        names in the order corresponding to internal constraint order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pyomo_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_constraints</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pyomo_constraints</span><span class="p">]</span></div>

<div class="viewcode-block" id="PyomoNLP.equality_constraint_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.equality_constraint_names">[docs]</a>    <span class="k">def</span> <span class="nf">equality_constraint_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData names in</span>
<span class="sd">        the order corresponding to the equality constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">equality_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_equality_constraints</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">equality_constraints</span><span class="p">]</span></div>

<div class="viewcode-block" id="PyomoNLP.inequality_constraint_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.inequality_constraint_names">[docs]</a>    <span class="k">def</span> <span class="nf">inequality_constraint_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData names in</span>
<span class="sd">        the order corresponding to the inequality constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inequality_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_inequality_constraints</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inequality_constraints</span><span class="p">]</span></div>

<div class="viewcode-block" id="PyomoNLP.get_primal_indices"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_primal_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_primal_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of indices for the primals</span>
<span class="sd">        corresponding to the list of Pyomo variables provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_variables : list of Pyomo Var or VarData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyomo_variables</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">var_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pyomo_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_indexed</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">var_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">[</span><span class="n">vd</span><span class="p">]</span>
                    <span class="n">var_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">var_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var_indices</span></div>

<div class="viewcode-block" id="PyomoNLP.get_constraint_indices"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_constraint_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_constraint_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of indices for the constraints</span>
<span class="sd">        corresponding to the list of Pyomo constraints provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_constraints : list of Pyomo Constraint or ConstraintData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyomo_constraints</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">con_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pyomo_constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_indexed</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">con_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span><span class="p">[</span><span class="n">cd</span><span class="p">]</span>
                    <span class="n">con_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">con_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_idx</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">con_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">con_indices</span></div>

<div class="viewcode-block" id="PyomoNLP.get_equality_constraint_indices"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_equality_constraint_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_equality_constraint_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of equality indices for the constraints</span>
<span class="sd">        corresponding to the list of Pyomo constraints provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : list of Pyomo Constraints or ConstraintData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_indexed</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">con_eq_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_eq_idx</span><span class="p">[</span><span class="n">cd</span><span class="p">]</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_eq_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">con_eq_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_eq_idx</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_eq_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indices</span></div>

<div class="viewcode-block" id="PyomoNLP.get_inequality_constraint_indices"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_inequality_constraint_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_inequality_constraint_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of inequality indices for the constraints</span>
<span class="sd">        corresponding to the list of Pyomo constraints provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : list of Pyomo Constraints or ConstraintData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_indexed</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">con_ineq_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_ineq_idx</span><span class="p">[</span><span class="n">cd</span><span class="p">]</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_ineq_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">con_ineq_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condata_to_ineq_idx</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_ineq_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indices</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoNLP.get_obj_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_obj_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_obj_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_objective</span><span class="p">()</span>
        <span class="n">scaling_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s1">&#39;scaling_factor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scaling_suffix</span> <span class="ow">and</span> <span class="n">scaling_suffix</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">is</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">scaling_suffix</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scaling_suffix</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoNLP.get_primals_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_primals_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_primals_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scaling_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s1">&#39;scaling_factor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scaling_suffix</span> <span class="ow">and</span> <span class="n">scaling_suffix</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">is</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">:</span>
            <span class="n">primals_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scaling_suffix</span><span class="p">:</span>
                    <span class="n">primals_scaling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaling_suffix</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">primals_scaling</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoNLP.get_constraints_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.get_constraints_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_constraints_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scaling_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s1">&#39;scaling_factor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scaling_suffix</span> <span class="ow">and</span> <span class="n">scaling_suffix</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">is</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">:</span>
            <span class="n">constraints_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_constraints</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">scaling_suffix</span><span class="p">:</span>
                    <span class="n">constraints_scaling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaling_suffix</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">constraints_scaling</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PyomoNLP.extract_subvector_grad_objective"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.extract_subvector_grad_objective">[docs]</a>    <span class="k">def</span> <span class="nf">extract_subvector_grad_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the gradient of the objective and return the entries</span>
<span class="sd">        corresponding to the given Pyomo variables</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_variables : list of Pyomo Var or VarData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grad_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_grad_objective</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">grad_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primal_indices</span><span class="p">(</span><span class="n">pyomo_variables</span><span class="p">)]</span></div>

<div class="viewcode-block" id="PyomoNLP.extract_subvector_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.extract_subvector_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">extract_subvector_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the values of the constraints</span>
<span class="sd">        corresponding to the list of Pyomo constraints provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_constraints : list of Pyomo Constraint or ConstraintData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_constraints</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">residuals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_constraint_indices</span><span class="p">(</span><span class="n">pyomo_constraints</span><span class="p">)]</span></div>

<div class="viewcode-block" id="PyomoNLP.extract_submatrix_jacobian"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.extract_submatrix_jacobian">[docs]</a>    <span class="k">def</span> <span class="nf">extract_submatrix_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_variables</span><span class="p">,</span> <span class="n">pyomo_constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the submatrix of the jacobian that corresponds to the list</span>
<span class="sd">        of Pyomo variables and list of Pyomo constraints provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_variables : list of Pyomo Var or VarData objects</span>
<span class="sd">        pyomo_constraints : list of Pyomo Constraint or ConstraintData objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_jacobian</span><span class="p">()</span>
        <span class="n">primal_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primal_indices</span><span class="p">(</span><span class="n">pyomo_variables</span><span class="p">)</span>
        <span class="n">constraint_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_constraint_indices</span><span class="p">(</span><span class="n">pyomo_constraints</span><span class="p">)</span>
        <span class="n">row_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">constraint_indices</span><span class="p">)</span>
        <span class="n">col_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">primal_indices</span><span class="p">)</span>
        <span class="n">submatrix_mask</span> <span class="o">=</span> <span class="n">row_mask</span> <span class="o">&amp;</span> <span class="n">col_mask</span>
        <span class="n">submatrix_irows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">jac</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
        <span class="n">submatrix_jcols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">jac</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="n">submatrix_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">jac</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># ToDo: this is expensive - have to think about how to do this with numpy</span>
        <span class="n">row_submatrix_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraint_indices</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">submatrix_irows</span><span class="p">):</span>
            <span class="n">submatrix_irows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_submatrix_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="n">col_submatrix_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">primal_indices</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">submatrix_jcols</span><span class="p">):</span>
            <span class="n">submatrix_jcols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_submatrix_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">submatrix_data</span><span class="p">,</span> <span class="p">(</span><span class="n">submatrix_irows</span><span class="p">,</span> <span class="n">submatrix_jcols</span><span class="p">)),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">primal_indices</span><span class="p">)),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PyomoNLP.extract_submatrix_hessian_lag"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.extract_submatrix_hessian_lag">[docs]</a>    <span class="k">def</span> <span class="nf">extract_submatrix_hessian_lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_variables_rows</span><span class="p">,</span> <span class="n">pyomo_variables_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the submatrix of the hessian of the lagrangian that</span>
<span class="sd">        corresponds to the list of Pyomo variables provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyomo_variables_rows : list of Pyomo Var or VarData objects</span>
<span class="sd">            List of Pyomo Var or VarData objects corresponding to the desired rows</span>
<span class="sd">        pyomo_variables_cols : list of Pyomo Var or VarData objects</span>
<span class="sd">            List of Pyomo Var or VarData objects corresponding to the desired columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hess_lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_hessian_lag</span><span class="p">()</span>
        <span class="n">primal_indices_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primal_indices</span><span class="p">(</span><span class="n">pyomo_variables_rows</span><span class="p">)</span>
        <span class="n">primal_indices_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primal_indices</span><span class="p">(</span><span class="n">pyomo_variables_cols</span><span class="p">)</span>
        <span class="n">row_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hess_lag</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">primal_indices_rows</span><span class="p">)</span>
        <span class="n">col_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hess_lag</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">primal_indices_cols</span><span class="p">)</span>
        <span class="n">submatrix_mask</span> <span class="o">=</span> <span class="n">row_mask</span> <span class="o">&amp;</span> <span class="n">col_mask</span>
        <span class="n">submatrix_irows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">hess_lag</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
        <span class="n">submatrix_jcols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">hess_lag</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="n">submatrix_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">submatrix_mask</span><span class="p">,</span> <span class="n">hess_lag</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># ToDo: this is expensive - have to think about how to do this with numpy</span>
        <span class="n">submatrix_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">primal_indices_rows</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">submatrix_irows</span><span class="p">):</span>
            <span class="n">submatrix_irows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">submatrix_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="n">submatrix_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">primal_indices_cols</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">submatrix_jcols</span><span class="p">):</span>
            <span class="n">submatrix_jcols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">submatrix_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">submatrix_data</span><span class="p">,</span> <span class="p">(</span><span class="n">submatrix_irows</span><span class="p">,</span> <span class="n">submatrix_jcols</span><span class="p">)),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">primal_indices_rows</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">primal_indices_cols</span><span class="p">)),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PyomoNLP.load_state_into_pyomo"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoNLP.load_state_into_pyomo">[docs]</a>    <span class="k">def</span> <span class="nf">load_state_into_pyomo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">primals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primals</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">primals</span><span class="p">):</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyomo_model</span><span class="p">()</span>
        <span class="n">model_suffixes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">active_import_suffix_generator</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;dual&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">duals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_duals</span><span class="p">()</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_constraints</span><span class="p">()</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;dual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;dual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">duals</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;ipopt_zL_out&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zL_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bound_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zL_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ipopt_zU_out&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zU_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bound_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zU_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span></div></div>


<span class="c1"># TODO: look for the [:-i] when i might be zero</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP">[docs]</a><span class="k">class</span> <span class="nc">PyomoGreyBoxNLP</span><span class="p">(</span><span class="n">NLP</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyomo_model</span><span class="p">):</span>
        <span class="c1"># store all the greybox custom block data objects</span>
        <span class="n">greybox_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We support Pynumero&#39;s ExternalGreyBoxBlock modeling</span>
            <span class="c1"># objects.  We need to find them and convert them to Blocks</span>
            <span class="c1"># before calling the NL writer so that the attached Vars get</span>
            <span class="c1"># picked up by the writer.</span>
            <span class="k">for</span> <span class="n">greybox</span> <span class="ow">in</span> <span class="n">pyomo_model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span>
                <span class="n">ExternalGreyBoxBlock</span><span class="p">,</span> <span class="n">descend_into</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">greybox</span><span class="o">.</span><span class="n">parent_block</span><span class="p">()</span><span class="o">.</span><span class="n">reclassify_component_type</span><span class="p">(</span><span class="n">greybox</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span>
                <span class="n">greybox_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">greybox</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span> <span class="o">=</span> <span class="n">pyomo_model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span> <span class="o">=</span> <span class="n">PyomoNLP</span><span class="p">(</span><span class="n">pyomo_model</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore the ctypes of the ExternalGreyBoxBlock components</span>
            <span class="k">for</span> <span class="n">greybox</span> <span class="ow">in</span> <span class="n">greybox_components</span><span class="p">:</span>
                <span class="n">greybox</span><span class="o">.</span><span class="n">parent_block</span><span class="p">()</span><span class="o">.</span><span class="n">reclassify_component_type</span><span class="p">(</span>
                    <span class="n">greybox</span><span class="p">,</span> <span class="n">ExternalGreyBoxBlock</span>
                <span class="p">)</span>

        <span class="c1"># get the greybox block data objects</span>
        <span class="n">greybox_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">greybox</span> <span class="ow">in</span> <span class="n">greybox_components</span><span class="p">:</span>
            <span class="n">greybox_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">greybox</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">greybox_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;The PyomoGreyBoxModel interface has not&quot;</span>
                <span class="s2">&quot; been tested with Pyomo models that contain&quot;</span>
                <span class="s2">&quot; more than one ExternalGreyBoxBlock. Currently,&quot;</span>
                <span class="s2">&quot; only a single block is supported.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No variables were found in the Pyomo part of the model.&quot;</span>
                <span class="s2">&quot; PyomoGreyBoxModel requires at least one variable&quot;</span>
                <span class="s2">&quot; to be active in a Pyomo objective or constraint&quot;</span>
            <span class="p">)</span>

        <span class="c1"># check that the greybox model supports what we would expect</span>
        <span class="c1"># TODO: add support for models that do not provide jacobians</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for data in greybox_data:</span>
<span class="sd">            c = data._ex_model.model_capabilities()</span>
<span class="sd">            if (c.n_equality_constraints() &gt; 0 \</span>
<span class="sd">               and not c.supports_jacobian_equality_constraints) \</span>
<span class="sd">               or (c.n_equality_constraints() &gt; 0 \</span>
<span class="sd">               and not c.supports_jacobian_equality_constraints)</span>
<span class="sd">                raise NotImplementedError(&#39;PyomoGreyBoxNLP does not support models&#39;</span>
<span class="sd">                                          &#39; without explicit Jacobian support&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># number of additional variables required - they are in the</span>
        <span class="c1"># greybox models but not included in the NL file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># number of residuals (equality constraints + output constraints</span>
        <span class="c1"># coming from the grey box models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Update the primal index map with any variables in the</span>
        <span class="c1"># greybox models that do not otherwise appear in the NL</span>
        <span class="c1"># and capture some other book keeping items</span>
        <span class="n">n_primals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span>
        <span class="n">greybox_primals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span> <span class="o">=</span> <span class="n">ComponentMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">greybox_data</span><span class="p">:</span>
            <span class="c1"># check that none of the inputs / outputs are fixed</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s1">&#39;Found a grey box model input that is fixed: </span><span class="si">{}</span><span class="s1">.&#39;</span>
                        <span class="s1">&#39; This interface does not currently support fixed&#39;</span>
                        <span class="s1">&#39; variables. Please add a constraint instead.&#39;</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s1">&#39;Found a grey box model output that is fixed: </span><span class="si">{}</span><span class="s1">.&#39;</span>
                        <span class="s1">&#39; This interface does not currently support fixed&#39;</span>
                        <span class="s1">&#39; variables. Please add a constraint instead.&#39;</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="p">)</span>

            <span class="n">block_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">equality_constraint_names</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block_name</span><span class="p">,</span> <span class="n">nm</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">output_names</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">_con&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block_name</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">component_data_objects</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">:</span>
                    <span class="c1"># there is a variable in the greybox block that</span>
                    <span class="c1"># is not in the NL - append this to the end</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_primals</span>
                    <span class="n">n_primals</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">greybox_primals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">var</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">fully_qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">greybox_primals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primal_variables</span> <span class="o">=</span> <span class="n">greybox_primals</span>

        <span class="c1"># Configure the primal and dual data caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_primals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">greybox_primals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_primals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">lb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">ub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_lb</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_ub</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_primals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># data member to store the cached greybox constraints and jacobian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_jac</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># create the helper objects</span>
        <span class="n">con_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">greybox_data</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">_ExternalGreyBoxModelHelper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vardata_to_idx</span><span class="p">,</span> <span class="n">con_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">con_offset</span> <span class="o">+=</span> <span class="n">h</span><span class="o">.</span><span class="n">n_residuals</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span> <span class="o">=</span> <span class="n">con_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_names</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span>

        <span class="c1"># make sure the primal values get to the greybox models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_primals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primals</span><span class="p">())</span>

        <span class="c1"># If any part of the problem is scaled (i.e., obj, primals,</span>
        <span class="c1"># or any of the constraints for any of the external grey boxes),</span>
        <span class="c1"># then we want scaling factors for everything (defaulting to</span>
        <span class="c1"># ones for any of the missing factors).</span>
        <span class="c1"># This code builds all the scaling factors, with the defaults,</span>
        <span class="c1"># but then sets them all to None if *no* scaling factors are provided</span>
        <span class="c1"># for any of the pieces. (inefficient, but only done once)</span>
        <span class="n">need_scaling</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_obj_scaling</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj_scaling</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">need_scaling</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_primals_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">())</span>
        <span class="n">scaling_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">_pyomo_model</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s1">&#39;scaling_factor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scaling_suffix</span> <span class="ow">and</span> <span class="n">scaling_suffix</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">is</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">:</span>
            <span class="n">need_scaling</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scaling_suffix</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_primals_scaling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaling_suffix</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pyomo_nlp_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_constraints_scaling</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pyomo_nlp_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyomo_nlp_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">need_scaling</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyomo_nlp_scaling</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">:</span>
            <span class="n">tmp_scaling</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get_residual_scaling</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tmp_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmp_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">n_residuals</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">need_scaling</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_scaling</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">need_scaling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj_scaling</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_primals_scaling</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># might want the user to be able to specify these at some point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_duals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_primals</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_duals</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_duals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_duals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># compute the jacobian for the external greybox models</span>
        <span class="c1"># to get some of the statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_greybox_jacobians_and_cache_if_necessary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_jac</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># make sure the duals get to the external greybox models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_duals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_duals</span><span class="p">())</span>

        <span class="c1"># compute the hessian for the external greybox models</span>
        <span class="c1"># to get some of the statistics</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_greybox_hessians_and_cache_if_necessary</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_invalidate_greybox_primals_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_cached</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_jac_cached</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_hess_cached</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_invalidate_greybox_duals_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_hess_cached</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.n_primals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.n_primals">[docs]</a>    <span class="k">def</span> <span class="nf">n_primals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.n_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.n_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">n_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span></div>

    <span class="c1"># overloaded from ExtendedNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.n_eq_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.n_eq_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">n_eq_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_eq_constraints</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span></div>

    <span class="c1"># overloaded from ExtendedNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.n_ineq_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.n_ineq_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">n_ineq_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_ineq_constraints</span><span class="p">()</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.nnz_jacobian"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.nnz_jacobian">[docs]</a>    <span class="k">def</span> <span class="nf">nnz_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">nnz_jacobian</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span></div>

    <span class="c1"># overloaded from AslNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.nnz_jacobian_eq"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.nnz_jacobian_eq">[docs]</a>    <span class="k">def</span> <span class="nf">nnz_jacobian_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">nnz_jacobian_eq</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.nnz_hessian_lag"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.nnz_hessian_lag">[docs]</a>    <span class="k">def</span> <span class="nf">nnz_hessian_lag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">nnz_hessian_lag</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.primals_lb"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.primals_lb">[docs]</a>    <span class="k">def</span> <span class="nf">primals_lb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">primals_lb</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_lb</span><span class="p">))</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.primals_ub"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.primals_ub">[docs]</a>    <span class="k">def</span> <span class="nf">primals_ub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">primals_ub</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_ub</span><span class="p">))</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.constraints_lb"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.constraints_lb">[docs]</a>    <span class="k">def</span> <span class="nf">constraints_lb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">constraints_lb</span><span class="p">(),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.constraints_ub"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.constraints_ub">[docs]</a>    <span class="k">def</span> <span class="nf">constraints_ub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">constraints_ub</span><span class="p">(),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.init_primals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.init_primals">[docs]</a>    <span class="k">def</span> <span class="nf">init_primals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">init_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_primals</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.init_duals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.init_duals">[docs]</a>    <span class="k">def</span> <span class="nf">init_duals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">init_duals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_duals</span><span class="p">))</span></div>

    <span class="c1"># overloaded from ExtendedNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.init_duals_eq"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.init_duals_eq">[docs]</a>    <span class="k">def</span> <span class="nf">init_duals_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">init_duals_eq</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_greybox_duals</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1"># overloaded from NLP / Extended NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.create_new_vector"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.create_new_vector">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;primals&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;constraints&#39;</span> <span class="ow">or</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;duals&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;eq_constraints&#39;</span> <span class="ow">or</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;duals_eq&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_eq_constraints</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;ineq_constraints&#39;</span> <span class="ow">or</span> <span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;duals_ineq&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ineq_constraints</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Called create_new_vector with an unknown vector_type&#39;</span><span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.set_primals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.set_primals">[docs]</a>    <span class="k">def</span> <span class="nf">set_primals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_greybox_primals_cache</span><span class="p">()</span>

        <span class="c1"># set the primals on the &quot;pyomo&quot; part of the nlp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">set_primals</span><span class="p">(</span><span class="n">primals</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()])</span>

        <span class="c1"># copy the values for the greybox primals</span>
        <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals</span><span class="p">,</span> <span class="n">primals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span> <span class="p">:])</span>

        <span class="k">for</span> <span class="n">external</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">:</span>
            <span class="n">external</span><span class="o">.</span><span class="n">set_primals</span><span class="p">(</span><span class="n">primals</span><span class="p">)</span></div>

    <span class="c1"># overloaded from AslNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_primals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_primals">[docs]</a>    <span class="k">def</span> <span class="nf">get_primals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return the value of the primals that the pyomo</span>
        <span class="c1"># part knows about as well as any extra values that</span>
        <span class="c1"># are only in the greybox part</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals</span><span class="p">))</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.set_duals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.set_duals">[docs]</a>    <span class="k">def</span> <span class="nf">set_duals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_greybox_duals_cache</span><span class="p">()</span>

        <span class="c1"># set the duals for the pyomo part of the nlp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">set_duals</span><span class="p">(</span><span class="n">duals</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()])</span>

        <span class="c1"># set the duals for the greybox part of the nlp</span>
        <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greybox_duals</span><span class="p">,</span> <span class="n">duals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span> <span class="p">:])</span>

        <span class="c1"># set the duals in the helpers for the hessian computation</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">set_duals</span><span class="p">(</span><span class="n">duals</span><span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_duals"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_duals">[docs]</a>    <span class="k">def</span> <span class="nf">get_duals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return the duals for the pyomo part of the nlp</span>
        <span class="c1"># concatenated with the greybox part</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_duals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_duals</span><span class="p">))</span></div>

    <span class="c1"># overloaded from ExtendedNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.set_duals_eq"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.set_duals_eq">[docs]</a>    <span class="k">def</span> <span class="nf">set_duals_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duals</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;set_duals_eq not implemented for PyomoGreyBoxNLP&#39;</span><span class="p">)</span>
        <span class="c1"># we think the code below is correct, but it has not yet been tested</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #self._invalidate_greybox_duals_cache()</span>

<span class="sd">        # set the duals for the pyomo part of the nlp</span>
<span class="sd">        self._pyomo_nlp.set_duals_eq(</span>
<span class="sd">            duals[:self._pyomo_nlp.n_equality_constraints()])</span>

<span class="sd">        # set the duals for the greybox part of the nlp</span>
<span class="sd">        np.copyto(self._greybox_duals, duals[self._pyomo_nlp.n_equality_constraints():])</span>
<span class="sd">        # set the duals in the helpers for the hessian computation</span>
<span class="sd">        for h in self._external_greybox_helpers:</span>
<span class="sd">            h.set_duals_eq(duals)</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="c1"># TODO: Implement set_duals_ineq</span>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_duals_eq"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_duals_eq">[docs]</a>    <span class="k">def</span> <span class="nf">get_duals_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;get_duals_eq not implemented for PyomoGreyBoxNLP&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # return the duals for the pyomo part of the nlp</span>
<span class="sd">        # concatenated with the greybox part</span>
<span class="sd">        return np.concatenate((</span>
<span class="sd">            self._pyomo_nlp.get_duals_eq(),</span>
<span class="sd">            self._greybox_duals,</span>
<span class="sd">        ))</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.set_obj_factor"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.set_obj_factor">[docs]</a>    <span class="k">def</span> <span class="nf">set_obj_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_factor</span><span class="p">):</span>
        <span class="c1"># objective is owned by the pyomo model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">set_obj_factor</span><span class="p">(</span><span class="n">obj_factor</span><span class="p">)</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_obj_factor"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_obj_factor">[docs]</a>    <span class="k">def</span> <span class="nf">get_obj_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># objective is owned by the pyomo model</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_obj_factor</span><span class="p">()</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_obj_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_obj_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_obj_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj_scaling</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_primals_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_primals_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_primals_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primals_scaling</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.get_constraints_scaling"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_constraints_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">get_constraints_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_scaling</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_objective"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_objective">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># objective is owned by the pyomo model</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_objective</span><span class="p">()</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_grad_objective"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_grad_objective">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_grad_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># objective is owned by the pyomo model</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_grad_objective</span><span class="p">(</span><span class="n">out</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_primals</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_evaluate_greybox_constraints_and_cache_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_cached</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_constraints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">external</span><span class="o">.</span><span class="n">evaluate_residuals</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">external</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_greybox_constraints_and_cache_if_necessary</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Called evaluate_constraints with an invalid&#39;</span>
                    <span class="s1">&#39; &quot;out&quot; argument - should take an ndarray of &#39;</span>
                    <span class="s1">&#39;size </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">())</span>
                <span class="p">)</span>

            <span class="c1"># call on the pyomo part of the nlp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_constraints</span><span class="p">(</span><span class="n">out</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span><span class="p">])</span>

            <span class="c1"># call on the greybox part of the nlp</span>
            <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span>
                <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_constraints</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># concatenate the pyomo and external constraint residuals</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_constraints</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_constraints</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

    <span class="c1"># overloaded from ExtendedNLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_eq_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_eq_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_eq_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Not yet implemented for PyomoGreyBoxNLP&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        self._evaluate_greybox_constraints_and_cache_if_necessary()</span>

<span class="sd">        if out is not None:</span>
<span class="sd">            if not isinstance(out, np.ndarray) \</span>
<span class="sd">               or out.size != self.n_eq_constraints():</span>
<span class="sd">                raise RuntimeError(</span>
<span class="sd">                    &#39;Called evaluate_eq_constraints with an invalid&#39;</span>
<span class="sd">                    &#39; &quot;out&quot; argument - should take an ndarray of &#39;</span>
<span class="sd">                    &#39;size {}&#39;.format(self.n_eq_constraints()))</span>
<span class="sd">            self._pyomo_nlp.evaluate_eq_constraints(</span>
<span class="sd">                out[:-self._n_greybox_constraints])</span>
<span class="sd">            np.copyto(out[-self._n_greybox_constraints:], self._cached_greybox_constraints)</span>
<span class="sd">            return out</span>
<span class="sd">        else:</span>
<span class="sd">            return np.concatenate((</span>
<span class="sd">                self._pyomo_nlp.evaluate_eq_constraints(),</span>
<span class="sd">                self._cached_greybox_constraints,</span>
<span class="sd">            ))</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">_evaluate_greybox_jacobians_and_cache_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_jac_cached</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">jac</span> <span class="o">=</span> <span class="n">BlockMatrix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">external</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">):</span>
            <span class="n">jac</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">external</span><span class="o">.</span><span class="n">evaluate_jacobian</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_jac</span> <span class="o">=</span> <span class="n">jac</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_jac_cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_jacobian"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_jacobian">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_greybox_jacobians_and_cache_if_necessary</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">coo_matrix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">nnz</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnz_jacobian</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;evaluate_jacobian called with an &quot;out&quot; argument&#39;</span>
                    <span class="s1">&#39; that is invalid. This should be a coo_matrix with&#39;</span>
                    <span class="s1">&#39; shape=(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">) and nnz=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnz_jacobian</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">n_pyomo_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_constraints</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_greybox_constraints</span>

            <span class="c1"># to avoid an additional copy, we pass in a slice (numpy view) of the underlying</span>
            <span class="c1"># data, row, and col that we were handed to be populated in evaluate_jacobian</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_jacobian</span><span class="p">(</span>
                <span class="n">out</span><span class="o">=</span><span class="n">coo_matrix</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span><span class="p">],</span>
                        <span class="p">(</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">row</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span><span class="p">],</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">col</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span><span class="p">],</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_pyomo_constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_jac</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_jac</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_jacobian</span><span class="p">()</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">col</span><span class="p">)),</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()),</span>
            <span class="p">)</span>

            <span class="n">jac</span> <span class="o">=</span> <span class="n">BlockMatrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">jac</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="n">jac</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_jac</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jac</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span></div>

            <span class="c1"># TODO: Doesn&#39;t this need a &quot;shape&quot; specification?</span>
            <span class="c1"># return coo_matrix((</span>
            <span class="c1">#    np.concatenate((base.data, self._cached_greybox_jac.data)),</span>
            <span class="c1">#    ( np.concatenate((base.row, self._cached_greybox_jac.row)),</span>
            <span class="c1">#      np.concatenate((base.col, self._cached_greybox_jac.col)) )</span>
            <span class="c1"># ))</span>

    <span class="c1"># overloaded from ExtendedNLP</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def evaluate_jacobian_eq(self, out=None):</span>
<span class="sd">        raise NotImplementedError()</span>
<span class="sd">        self._evaluate_greybox_jacobians_and_cache_if_necessary()</span>

<span class="sd">        if out is not None:</span>
<span class="sd">            if ( not isinstance(out, coo_matrix)</span>
<span class="sd">                 or out.shape[0] != self.n_eq_constraints()</span>
<span class="sd">                 or out.shape[1] != self.n_primals()</span>
<span class="sd">                 or out.nnz != self.nnz_jacobian_eq() ):</span>
<span class="sd">                raise RuntimeError(</span>
<span class="sd">                    &#39;evaluate_jacobian called with an &quot;out&quot; argument&#39;</span>
<span class="sd">                    &#39; that is invalid. This should be a coo_matrix with&#39;</span>
<span class="sd">                    &#39; shape=({},{}) and nnz={}&#39;</span>
<span class="sd">                    .format(self.n_eq_constraints(), self.n_primals(),</span>
<span class="sd">                            self.nnz_jacobian_eq()))</span>
<span class="sd">            self._pyomo_nlp.evaluate_jacobian_eq(</span>
<span class="sd">                coo_matrix((out.data[:-self._nnz_greybox_jac],</span>
<span class="sd">                            (out.row[:-self._nnz_greybox_jac],</span>
<span class="sd">                             out.col[:-self._nnz_greybox_jac])))</span>
<span class="sd">            )</span>
<span class="sd">            np.copyto(out.data[-self._nnz_greybox_jac],</span>
<span class="sd">                      self._cached_greybox_jac.data)</span>
<span class="sd">            return out</span>
<span class="sd">        else:</span>
<span class="sd">            base = self._pyomo_nlp.evaluate_jacobian_eq()</span>
<span class="sd">            # TODO: Doesn&#39;t this need a &quot;shape&quot; specification?</span>
<span class="sd">            return coo_matrix((</span>
<span class="sd">                np.concatenate((base.data, self._cached_greybox_jac.data)),</span>
<span class="sd">                ( np.concatenate((base.row, self._cached_greybox_jac.row)),</span>
<span class="sd">                  np.concatenate((base.col, self._cached_greybox_jac.col)) )</span>
<span class="sd">            ))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># overloaded from NLP</span>
    <span class="k">def</span> <span class="nf">_evaluate_greybox_hessians_and_cache_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_hess_cached</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">irow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">jcol</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">external</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_greybox_helpers</span><span class="p">:</span>
            <span class="n">hess</span> <span class="o">=</span> <span class="n">external</span><span class="o">.</span><span class="n">evaluate_hessian</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hess</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">irow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hess</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
            <span class="n">jcol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hess</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">irow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">irow</span><span class="p">)</span>
        <span class="n">jcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">jcol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">jcol</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_hess_cached</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PyomoGreyBoxNLP.evaluate_hessian_lag"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.evaluate_hessian_lag">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_hessian_lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_greybox_hessians_and_cache_if_necessary</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">coo_matrix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">nnz</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnz_hessian_lag</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;evaluate_hessian_lag called with an &quot;out&quot; argument&#39;</span>
                    <span class="s1">&#39; that is invalid. This should be a coo_matrix with&#39;</span>
                    <span class="s1">&#39; shape=(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">) and nnz=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnz_hessian</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="c1"># to avoid an additional copy, we pass in a slice (numpy view) of the underlying</span>
            <span class="c1"># data, row, and col that we were handed to be populated in evaluate_hessian_lag</span>
            <span class="c1"># the coo_matrix is simply a holder of the data, row, and col structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_hessian_lag</span><span class="p">(</span>
                <span class="n">out</span><span class="o">=</span><span class="n">coo_matrix</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span><span class="p">],</span>
                        <span class="p">(</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">row</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span><span class="p">],</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">col</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span><span class="p">],</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">n_primals</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span>
                <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_nnz_greybox_hess</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">evaluate_hessian_lag</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">hess</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">hess</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span><span class="o">.</span><span class="n">row</span><span class="p">))</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">hess</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_greybox_hess</span><span class="o">.</span><span class="n">col</span><span class="p">))</span>
            <span class="n">hess</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_primals</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">hess</span></div>

    <span class="c1"># overloaded from NLP</span>
<div class="viewcode-block" id="PyomoGreyBoxNLP.report_solver_status"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.report_solver_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_solver_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">status_message</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Todo: implement this&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.variable_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.variable_names">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span>
        <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;This method has been replaced with primals_names&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;6.0.0.dev0&#39;</span><span class="p">,</span>
        <span class="n">remove_in</span><span class="o">=</span><span class="s1">&#39;6.0&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">variable_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primals_names</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.primals_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.primals_names">[docs]</a>    <span class="k">def</span> <span class="nf">primals_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">variable_names</span><span class="p">())</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primals_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.constraint_names"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.constraint_names">[docs]</a>    <span class="k">def</span> <span class="nf">constraint_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">constraint_names</span><span class="p">())</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greybox_constraints_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.pyomo_model"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.pyomo_model">[docs]</a>    <span class="k">def</span> <span class="nf">pyomo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return optimization model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_model</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.get_pyomo_objective"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_pyomo_objective">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of the active objective function on the Pyomo model.</span>
<span class="sd">        (there can be only one)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_pyomo_objective</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.get_pyomo_variables"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_pyomo_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo VarData objects in</span>
<span class="sd">        the order corresponding to the primals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyomo_nlp</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greybox_primal_variables</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.get_pyomo_constraints"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.get_pyomo_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyomo_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of the Pyomo ConData objects in</span>
<span class="sd">        the order corresponding to the primals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: what do we return for the external block constraints?</span>
        <span class="c1"># return self._pyomo_nlp.get_pyomo_constraints()</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;returning list of all constraints when using an external model is TBD&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PyomoGreyBoxNLP.load_state_into_pyomo"><a class="viewcode-back" href="../../../../../contributed_packages/pynumero/pynumero.interfaces.pyomo_grey_box_nlp.html#pyomo.contrib.pynumero.interfaces.pyomo_nlp.PyomoGreyBoxNLP.load_state_into_pyomo">[docs]</a>    <span class="k">def</span> <span class="nf">load_state_into_pyomo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">primals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primals</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pyomo_variables</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">primals</span><span class="p">):</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyomo_model</span><span class="p">()</span>
        <span class="n">model_suffixes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">active_import_suffix_generator</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;dual&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;dual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="c1"># Until we sort out how to return the duals for the external</span>
            <span class="c1"># block (implied) constraints, I am disabling *all* duals</span>
            <span class="c1">#</span>
            <span class="c1"># duals = self.get_duals()</span>
            <span class="c1"># constraints = self.get_pyomo_constraints()</span>
            <span class="c1"># model_suffixes[&#39;dual&#39;].update(</span>
            <span class="c1">#     zip(constraints, duals))</span>
        <span class="k">if</span> <span class="s1">&#39;ipopt_zL_out&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zL_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bound_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zL_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ipopt_zU_out&#39;</span> <span class="ow">in</span> <span class="n">model_suffixes</span><span class="p">:</span>
            <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zU_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bound_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_suffixes</span><span class="p">[</span><span class="s1">&#39;ipopt_zU_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">bound_multipliers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_ExternalGreyBoxModelHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_grey_box_block</span><span class="p">,</span> <span class="n">vardata_to_idx</span><span class="p">,</span> <span class="n">con_offset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This helper takes an ExternalGreyBoxModel and provides the residual,</span>
<span class="sd">        Jacobian, and Hessian computation mapped to the correct variable space.</span>

<span class="sd">        The ExternalGreyBoxModel provides an interface that supports</span>
<span class="sd">        equality constraints (pure residuals) and output equations. Let</span>
<span class="sd">        u be the inputs, o be the outputs, and x be the full set of</span>
<span class="sd">        primal variables from the entire pyomo_nlp.</span>

<span class="sd">        With this, the ExternalGreyBoxModel provides the residual</span>
<span class="sd">        computations w_eq(u), and w_o(u), as well as the Jacobians,</span>
<span class="sd">        Jw_eq(u), and Jw_o(u). This helper provides h(x)=0, where h(x) =</span>
<span class="sd">        [h_eq(x); h_o(x)-o] and h_eq(x)=w_eq(Pu*x), and</span>
<span class="sd">        h_o(x)=w_o(Pu*x), and Pu is a mapping from the full primal</span>
<span class="sd">        variables &quot;x&quot; to the inputs &quot;u&quot;.</span>

<span class="sd">        It also provides the Jacobian of h w.r.t. x.</span>
<span class="sd">           J_h(x) = [Jw_eq(Pu*x); Jw_o(Pu*x)-Po*x]</span>
<span class="sd">        where Po is a mapping from the full primal variables &quot;x&quot; to the</span>
<span class="sd">        outputs &quot;o&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block</span> <span class="o">=</span> <span class="n">ex_grey_box_block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span> <span class="o">=</span> <span class="n">ex_grey_box_block</span><span class="o">.</span><span class="n">get_external_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_primals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vardata_to_idx</span><span class="p">)</span>
        <span class="n">n_inputs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">n_inputs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">()</span>
        <span class="n">n_eq_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span>
        <span class="n">n_outputs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">n_outputs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span>

        <span class="c1"># store the map of input indices (0 .. n_inputs) to</span>
        <span class="c1"># the indices in the full primals vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">vardata_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="n">n_inputs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># store the map of output indices (0 .. n_outputs) to</span>
        <span class="c1"># the indices in the full primals vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_to_primals_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">vardata_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="n">n_outputs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;ExternalGreyBoxModel has no equality constraints &#39;</span>
                <span class="s1">&#39;or outputs. It must have at least one or both.&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ex_eq_duals_to_full_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">n_eq_constraints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_eq_duals_to_full_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">con_offset</span><span class="p">,</span> <span class="n">con_offset</span> <span class="o">+</span> <span class="n">n_eq_constraints</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ex_output_duals_to_full_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">n_outputs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_output_duals_to_full_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span>
                    <span class="n">con_offset</span> <span class="o">+</span> <span class="n">n_eq_constraints</span><span class="p">,</span>
                    <span class="n">con_offset</span> <span class="o">+</span> <span class="n">n_eq_constraints</span> <span class="o">+</span> <span class="n">n_outputs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># we need to change the column indices in the jacobian</span>
        <span class="c1"># from the 0..n_inputs provided by the external model</span>
        <span class="c1"># to the indices corresponding to the full Pyomo model</span>
        <span class="c1"># so we create that here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eq_jac_primal_jcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_jac_primal_jcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_irow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_jcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_con_offset</span> <span class="o">=</span> <span class="n">con_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_jcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_irow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_jcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_irow</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_primals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primals</span><span class="p">):</span>
        <span class="c1"># map the full primals &quot;x&quot; to the inputs &quot;u&quot; and set</span>
        <span class="c1"># the values on the external model</span>
        <span class="n">input_values</span> <span class="o">=</span> <span class="n">primals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">set_input_values</span><span class="p">(</span><span class="n">input_values</span><span class="p">)</span>

        <span class="c1"># map the full primals &quot;x&quot; to the outputs &quot;o&quot; and</span>
        <span class="c1"># store a vector of the current output values to</span>
        <span class="c1"># use when evaluating residuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_values</span> <span class="o">=</span> <span class="n">primals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs_to_primals_map</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_duals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duals</span><span class="p">):</span>
        <span class="c1"># map the full duals to the duals for the equality</span>
        <span class="c1"># and the output constraints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_eq_duals_to_full_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duals_eq</span> <span class="o">=</span> <span class="n">duals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_eq_duals_to_full_map</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">set_equality_constraint_multipliers</span><span class="p">(</span><span class="n">duals_eq</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_output_duals_to_full_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duals_outputs</span> <span class="o">=</span> <span class="n">duals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_output_duals_to_full_map</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">set_output_constraint_multipliers</span><span class="p">(</span><span class="n">duals_outputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">n_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_residual_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eq_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">get_equality_constraint_scaling_factors</span><span class="p">()</span>
        <span class="n">output_con_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">get_output_constraint_scaling_factors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eq_scaling</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_con_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">eq_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eq_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">output_con_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_con_scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">eq_scaling</span><span class="p">,</span> <span class="n">output_con_scaling</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">evaluate_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># evaluate the equality constraints and the output equations</span>
        <span class="c1"># and return a single vector of residuals</span>
        <span class="c1"># returns residual for h(x)=0, where h(x) = [h_eq(x); h_o(x)-o]</span>
        <span class="n">resid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_equality_constraints</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">computed_output_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_outputs</span><span class="p">()</span>
            <span class="n">output_resid</span> <span class="o">=</span> <span class="n">computed_output_values</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_values</span>
            <span class="n">resid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_resid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">resid_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compute the jacobian of h(x) w.r.t. x</span>
        <span class="c1"># J_h(x) = [Jw_eq(Pu*x); Jw_o(Pu*x)-Po*x]</span>

        <span class="c1"># Jw_eq(x)</span>
        <span class="n">eq_jac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eq_jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_jacobian_equality_constraints</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eq_jac_primal_jcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># The first time through, we won&#39;t have created the</span>
                <span class="c1"># mapping of external primals (&#39;u&#39;) to the full space</span>
                <span class="c1"># primals (&#39;x&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eq_jac_primal_jcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span><span class="n">eq_jac</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
            <span class="c1"># map the columns from the inputs &quot;u&quot; back to the full primals &quot;x&quot;</span>
            <span class="n">eq_jac</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">eq_jac</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">eq_jac</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eq_jac_primal_jcol</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">eq_jac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_primals</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">outputs_jac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outputs_jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_jacobian_outputs</span><span class="p">()</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">outputs_jac</span><span class="o">.</span><span class="n">row</span>
            <span class="c1"># map the columns from the inputs &quot;u&quot; back to the full primals &quot;x&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_jac_primal_jcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># The first time through, we won&#39;t have created the</span>
                <span class="c1"># mapping of external outputs (&#39;o&#39;) to the full space</span>
                <span class="c1"># primals (&#39;x&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_jac_primal_jcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span>
                    <span class="n">outputs_jac</span><span class="o">.</span><span class="n">col</span>
                <span class="p">]</span>

                <span class="c1"># We also need tocreate the irow, jcol, nnz structure for the</span>
                <span class="c1"># output variable portion of h(u)-o=0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_irow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_jcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_to_primals_map</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_data</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs_jac_primal_jcol</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">outputs_jac</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># add the additional entries for the -Po*x portion of the jacobian</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_irow</span><span class="p">))</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_jcol</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_output_entries_data</span><span class="p">))</span>
            <span class="n">outputs_jac</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">outputs_jac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_primals</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">jac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">eq_jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outputs_jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># create a jacobian with both Jw_eq and Jw_o</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="n">BlockMatrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">jac</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;external model jacobian&#39;</span>
                <span class="n">jac</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eq_jac</span><span class="p">)</span>
                <span class="n">jac</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">outputs_jac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="c1"># only need the Jacobian with Jw_eq (there are not</span>
                <span class="c1"># output equations)</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="n">eq_jac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">outputs_jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="c1"># only need the Jacobian with Jw_o (there are no equalities)</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">outputs_jac</span>

        <span class="k">return</span> <span class="n">jac</span>

    <span class="k">def</span> <span class="nf">evaluate_hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compute the portion of the Hessian of the Lagrangian</span>
        <span class="c1"># of h(x) w.r.t. x</span>
        <span class="c1"># H_h(x) = sum_i y_eq_i * Hw_eq(Pu*x) +_ sum_k y_o_j * Hw_o(Pu*x)]</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">irow_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jcol_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Hw_eq(x)</span>
        <span class="n">eq_hess</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_equality_constraints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eq_hess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_hessian_equality_constraints</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_jcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># first time through, let&#39;s also check that it is lower triangular</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">eq_hess</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="n">eq_hess</span><span class="o">.</span><span class="n">col</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;ExternalGreyBoxModel must return lower &#39;</span>
                        <span class="s1">&#39;triangular portion of the Hessian only&#39;</span>
                    <span class="p">)</span>

                <span class="c1"># The first time through, we won&#39;t have created the</span>
                <span class="c1"># mapping of external primals (&#39;u&#39;) to the full space</span>
                <span class="c1"># primals (&#39;x&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_irow</span> <span class="o">=</span> <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span><span class="n">eq_hess</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_jcol</span> <span class="o">=</span> <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span><span class="n">eq_hess</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>

                <span class="c1"># mapping may have made this not lower triangular</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="n">row</span>
                <span class="n">row</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq_hess</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">irow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_irow</span><span class="p">)</span>
            <span class="n">jcol_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eq_hess_jcol</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output_hess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_model</span><span class="o">.</span><span class="n">evaluate_hessian_outputs</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_irow</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># first time through, let&#39;s also check that it is lower triangular</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">output_hess</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="n">output_hess</span><span class="o">.</span><span class="n">col</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;ExternalGreyBoxModel must return lower &#39;</span>
                        <span class="s1">&#39;triangular portion of the Hessian only&#39;</span>
                    <span class="p">)</span>

                <span class="c1"># The first time through, we won&#39;t have created the</span>
                <span class="c1"># mapping of external outputs (&#39;o&#39;) to the full space</span>
                <span class="c1"># primals (&#39;x&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_irow</span> <span class="o">=</span> <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span>
                    <span class="n">output_hess</span><span class="o">.</span><span class="n">row</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_jcol</span> <span class="o">=</span> <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_to_primals_map</span><span class="p">[</span>
                    <span class="n">output_hess</span><span class="o">.</span><span class="n">col</span>
                <span class="p">]</span>

                <span class="c1"># mapping may have made this not lower triangular</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="n">row</span>
                <span class="n">row</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_hess</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">irow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_irow</span><span class="p">)</span>
            <span class="n">jcol_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_hess_jcol</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
        <span class="n">irow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">irow_list</span><span class="p">)</span>
        <span class="n">jcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">jcol_list</span><span class="p">)</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">jcol</span><span class="p">)),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_primals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_primals</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">hess</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2008-2023, Sandia National Laboratories.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>