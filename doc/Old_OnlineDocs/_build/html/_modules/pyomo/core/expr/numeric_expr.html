

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyomo.core.expr.numeric_expr &mdash; Pyomo 6.5.1.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Pyomo
          

          
          </a>

          
            
            
              <div class="version">
                6.5.1.dev0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../citing_pyomo.html">Citing Pyomo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyomo_overview/index.html">Pyomo Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyomo_modeling_components/index.html">Pyomo Modeling Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../solving_pyomo_models.html">Solving Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_models.html">Working with Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_abstractmodels/index.html">Working with Abstract Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_transformations/index.html">Model Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modeling_extensions/index.html">Modeling Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial_examples.html">Pyomo Tutorial Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_debugging/index.html">Debugging Pyomo Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_topics/index.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../errors.html">Common Warnings/Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_reference/index.html">Developer Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../library_reference/index.html">Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_guide.html">Contributing to Pyomo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributed_packages/index.html">Third-Party Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../related_packages.html">Related Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bibliography.html">Bibliography</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pyomo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>pyomo.core.expr.numeric_expr</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyomo.core.expr.numeric_expr</h1><div class="highlight"><pre>
<span></span><span class="c1">#  ___________________________________________________________________________</span>
<span class="c1">#</span>
<span class="c1">#  Pyomo: Python Optimization Modeling Objects</span>
<span class="c1">#  Copyright (c) 2008-2022</span>
<span class="c1">#  National Technology and Engineering Solutions of Sandia, LLC</span>
<span class="c1">#  Under the terms of Contract DE-NA0003525 with National Technology and</span>
<span class="c1">#  Engineering Solutions of Sandia, LLC, the U.S. Government retains certain</span>
<span class="c1">#  rights in this software.</span>
<span class="c1">#  This software is distributed under the 3-clause BSD License.</span>
<span class="c1">#  ___________________________________________________________________________</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pyomo.core&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>
<span class="kn">from</span> <span class="nn">pyomo.common.deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">deprecation_warning</span>
<span class="kn">from</span> <span class="nn">pyomo.common.formatting</span> <span class="kn">import</span> <span class="n">tostr</span>

<span class="kn">from</span> <span class="nn">.expr_common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OperatorAssociativity</span><span class="p">,</span>
    <span class="n">ExpressionType</span><span class="p">,</span>
    <span class="n">clone_counter</span><span class="p">,</span>
    <span class="n">_add</span><span class="p">,</span>
    <span class="n">_sub</span><span class="p">,</span>
    <span class="n">_mul</span><span class="p">,</span>
    <span class="n">_div</span><span class="p">,</span>
    <span class="n">_pow</span><span class="p">,</span>
    <span class="n">_neg</span><span class="p">,</span>
    <span class="n">_abs</span><span class="p">,</span>
    <span class="n">_inplace</span><span class="p">,</span>
    <span class="n">_unary</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">ExpressionBase</span><span class="p">,</span> <span class="n">NPV_Mixin</span>
<span class="kn">from</span> <span class="nn">.numvalue</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NumericValue</span><span class="p">,</span>
    <span class="n">native_types</span><span class="p">,</span>
    <span class="n">nonpyomo_leaf_types</span><span class="p">,</span>
    <span class="n">native_numeric_types</span><span class="p">,</span>
    <span class="n">as_numeric</span><span class="p">,</span>
    <span class="n">value</span><span class="p">,</span>
    <span class="n">is_potentially_variable</span><span class="p">,</span>
    <span class="n">check_if_numeric_type</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.visitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">evaluate_expression</span><span class="p">,</span>
    <span class="n">expression_to_string</span><span class="p">,</span>
    <span class="n">polynomial_degree</span><span class="p">,</span>
    <span class="n">clone_expression</span><span class="p">,</span>
    <span class="n">sizeof_expression</span><span class="p">,</span>
    <span class="n">_expression_is_fixed</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_zero_one_optimizations</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">enable_expression_optimizations</span><span class="p">(</span><span class="n">zero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enable(disable) expression generation optimizations</span>

<span class="sd">    There are currently two optimizations available during expression generation:</span>

<span class="sd">    - zero: aggressively resolve `0*f(.)` expressions to `0`, `0/f(.)`</span>
<span class="sd">      expressions to `0`, and `f(.)**0` expressions to `1`</span>

<span class="sd">    - one: aggressively resolve identities: `1*f(.)` expressions to</span>
<span class="sd">      `f(.)`, `f(.)/1` expressions to `f(.)`, and `f(.)**1` expressions</span>
<span class="sd">      to `f(.)`.</span>

<span class="sd">    The default optimizations are `zero=False` and `one=True`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Enabling the `zero` optimization can mask certain modeling errors.</span>
<span class="sd">    In particular, the optimization will suppress `ZeroDivisionError`s</span>
<span class="sd">    that should be raised if `f(.)` resolves to `0` (in the case of</span>
<span class="sd">    `0/f(.)`), as well as any errors that would have otherwise been</span>
<span class="sd">    raised during the evaluation of `f(.)`.  In addition, optimizing</span>
<span class="sd">    `f(.)**0 == 1` is only valid when `f(.)!=0`.  **Users who enable</span>
<span class="sd">    this optimization bear responsibility for ensuring that these</span>
<span class="sd">    optimizations will be valid for the model.**</span>

<span class="sd">    The `one` optimizations should generally be safe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    zero: bool, optional</span>

<span class="sd">        If `True` (`False`), enable (disable) the &quot;zero&quot; optimizations.</span>
<span class="sd">        If None, leave the optimization state unchanged.</span>

<span class="sd">    one: bool, optional</span>

<span class="sd">        If `True` (`False`), enable (disable) the &quot;one&quot; optimizations.</span>
<span class="sd">        If None, leave the optimization state unchanged.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">((</span><span class="n">zero</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">_zero_one_optimizations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_zero_one_optimizations</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">mutable_expression</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for mutable sums.</span>

<span class="sd">    This context manager is used to compute a sum while treating the</span>
<span class="sd">    summation as a mutable object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">_MutableNPVSumExpression</span><span class="p">([])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">_MutableSumExpression</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">make_immutable</span><span class="p">()</span>


<div class="viewcode-block" id="nonlinear_expression"><a class="viewcode-back" href="../../../../library_reference/expressions/context_managers.html#pyomo.core.expr.current.nonlinear_expression">[docs]</a><span class="k">class</span> <span class="nc">nonlinear_expression</span><span class="p">(</span><span class="n">mutable_expression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for mutable nonlinear sums.</span>

<span class="sd">    This context manager is used to compute a general nonlinear sum</span>
<span class="sd">    while treating the summation as a mutable object.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>

<span class="sd">    The preferred context manager is :py:class:`mutable_expression`, as</span>
<span class="sd">    the return type will be the most specific of</span>
<span class="sd">    :py:class:`SumExpression`, :py:class:`LinearExpression`, or</span>
<span class="sd">    :py:class:`NPV_SumExpression`.  This context manager will *always*</span>
<span class="sd">    return a :py:class:`SumExpression`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">_MutableSumExpression</span><span class="p">([])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span></div>


<div class="viewcode-block" id="linear_expression"><a class="viewcode-back" href="../../../../library_reference/expressions/context_managers.html#pyomo.core.expr.current.linear_expression">[docs]</a><span class="k">class</span> <span class="nc">linear_expression</span><span class="p">(</span><span class="n">mutable_expression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for mutable linear sums.</span>

<span class="sd">    This context manager is used to compute a linear sum while</span>
<span class="sd">    treating the summation as a mutable object.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>

<span class="sd">    The preferred context manager is :py:class:`mutable_expression`.</span>
<span class="sd">    :py:class:`linear_expression` is an alias to</span>
<span class="sd">    :py:class:`mutable_expression` provided for backwards compatibility.</span>

<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Expression classes</span>
<span class="c1">#</span>
<span class="c1"># -------------------------------------------------------</span>


<div class="viewcode-block" id="NumericExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression">[docs]</a><span class="k">class</span> <span class="nc">NumericExpression</span><span class="p">(</span><span class="n">ExpressionBase</span><span class="p">,</span> <span class="n">NumericValue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class for Pyomo expressions.</span>

<span class="sd">    This class is used to define nodes in a numeric expression</span>
<span class="sd">    tree.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (list or tuple): Children of this node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Previously, we used _args to define expression class arguments.</span>
    <span class="c1"># Here, we use _args_ to force errors for code that was referencing this</span>
    <span class="c1"># data.  There are now accessor methods, so in most cases users</span>
    <span class="c1"># and developers should not directly access the _args_ data values.</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_args_&#39;</span><span class="p">,)</span>
    <span class="n">EXPRESSION_SYSTEM</span> <span class="o">=</span> <span class="n">ExpressionType</span><span class="o">.</span><span class="n">NUMERIC</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="NumericExpression.__init__"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="n">args</span></div>

<div class="viewcode-block" id="NumericExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># by default, Pyomo numeric operators are binary operators</span>
        <span class="k">return</span> <span class="mi">2</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the child nodes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or tuple:</span>
<span class="sd">            Sequence containing only the child nodes of this node.  The</span>
<span class="sd">            return type depends on the node storage model.  Users are</span>
<span class="sd">            not permitted to change the returned data (even for the case</span>
<span class="sd">            of data returned as a list), as that breaks the promise of</span>
<span class="sd">            tree immutability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span>

<div class="viewcode-block" id="NumericExpression.create_potentially_variable_object"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression.create_potentially_variable_object">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span>
        <span class="s1">&#39;The implicit recasting of a &quot;not potentially variable&quot; &#39;</span>
        <span class="s1">&#39;expression node to a potentially variable one is no &#39;</span>
        <span class="s1">&#39;longer supported (this violates that immutability &#39;</span>
        <span class="s1">&#39;promise for Pyomo5 expression trees).&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;6.4.3&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_potentially_variable_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a potentially variable version of this object.</span>

<span class="sd">        This method returns an object that is a potentially variable</span>
<span class="sd">        version of the current object.  In the simplest</span>
<span class="sd">        case, this simply sets the value of `__class__`:</span>

<span class="sd">            self.__class__ = self.__class__.__mro__[1]</span>

<span class="sd">        Note that this method is allowed to modify the current object</span>
<span class="sd">        and return it.  But in some cases it may create a new</span>
<span class="sd">        potentially variable object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An object that is potentially variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;recasting a non-potentially variable expression to a &#39;</span>
                <span class="s1">&#39;potentially variable one violates the immutability &#39;</span>
                <span class="s1">&#39;promise for Pyomo expression trees.&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potentially_variable_base_class</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="NumericExpression.polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression.polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the polynomial degree of the expression.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A non-negative integer that is the polynomial</span>
<span class="sd">            degree if the expression is polynomial, or :const:`None` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="NumericExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NumericExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the polynomial degree of this expression given</span>
<span class="sd">        the degree values of its children.</span>

<span class="sd">        This method is called by the :class:`_PolynomialDegreeVisitor</span>
<span class="sd">        &lt;pyomo.core.expr.current._PolynomialDegreeVisitor&gt;` class.  It can</span>
<span class="sd">        be over-written by expression classes to customize this</span>
<span class="sd">        logic.</span>

<span class="sd">        Args:</span>
<span class="sd">            values (list): A list of values that indicate the degree</span>
<span class="sd">                of the children expression.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A nonnegative integer that is the polynomial degree of the</span>
<span class="sd">            expression, or :const:`None`.  Default is :const:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<span class="k">class</span> <span class="nc">Numeric_NPV_Mixin</span><span class="p">(</span><span class="n">NPV_Mixin</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">potentially_variable_base_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># Special cases: unary operators on NPV expressions are NPV</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NPV_NegationExpression</span><span class="p">((</span><span class="bp">self</span><span class="p">,))</span>

    <span class="k">def</span> <span class="fm">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NPV_AbsExpression</span><span class="p">((</span><span class="bp">self</span><span class="p">,))</span>


<div class="viewcode-block" id="NegationExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression">[docs]</a><span class="k">class</span> <span class="nc">NegationExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Negation expressions::</span>

<span class="sd">        - x</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="NegationExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="NegationExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;neg&#39;</span></div>

<div class="viewcode-block" id="NegationExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="NegationExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># TODO: remove space after negation</span>
        <span class="k">return</span> <span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="NegationExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.NegationExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">NPV_NegationExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">NegationExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># Because NPV also defines __neg__ we need to override it here, too</span>
    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="ExternalFunctionExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression">[docs]</a><span class="k">class</span> <span class="nc">ExternalFunctionExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    External function expressions</span>

<span class="sd">    Example::</span>

<span class="sd">        model = ConcreteModel()</span>
<span class="sd">        model.a = Var()</span>
<span class="sd">        model.f = ExternalFunction(library=&#39;foo.so&#39;, function=&#39;bar&#39;)</span>
<span class="sd">        expr = model.f(model.a)</span>

<span class="sd">    Args:</span>
<span class="sd">        args (tuple): children of this node</span>
<span class="sd">        fcn: a class that defines this external function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_fcn&#39;</span><span class="p">,)</span>

    <span class="c1"># This operator does not have an infix representation</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">fcn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span> <span class="o">=</span> <span class="n">fcn</span>

<div class="viewcode-block" id="ExternalFunctionExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression.create_node_with_local_data"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression.create_node_with_local_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_node_with_local_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">return</span> <span class="n">classtype</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression.get_arg_units"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression.get_arg_units">[docs]</a>    <span class="k">def</span> <span class="nf">get_arg_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the units for this external functions arguments&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="o">.</span><span class="n">get_arg_units</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExternalFunctionExpression.get_units"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ExternalFunctionExpression.get_units">[docs]</a>    <span class="k">def</span> <span class="nf">get_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the units of the return value for this external function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="o">.</span><span class="n">get_units</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">NPV_ExternalFunctionExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">ExternalFunctionExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">PowExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Power expressions::</span>

<span class="sd">        x**y</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># &quot;**&quot; is right-to-left associative in Python (so this should</span>
    <span class="c1"># return -1), however, as this rule is not widely known and can</span>
    <span class="c1"># confuse novice users, we will make our &quot;**&quot; operator</span>
    <span class="c1"># non-associative (forcing parens)</span>
    <span class="n">ASSOCIATIVITY</span> <span class="o">=</span> <span class="n">OperatorAssociativity</span><span class="o">.</span><span class="n">NON_ASSOCIATIVE</span>

    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># PowExpression is a tricky thing.  In general, a**b is</span>
        <span class="c1"># nonpolynomial, however, if b == 0, it is a constant</span>
        <span class="c1"># expression, and if a is polynomial and b is a positive</span>
        <span class="c1"># integer, it is also polynomial.  While we would like to just</span>
        <span class="c1"># call this a non-polynomial expression, these exceptions occur</span>
        <span class="c1"># too frequently (and in particular, a**2)</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># NOTE: use value before int() so that we don&#39;t</span>
            <span class="c1">#       run into the disabled __int__ method on</span>
            <span class="c1">#       NumericValue</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">exp</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">l</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_is_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">_l</span><span class="p">,</span> <span class="n">_r</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">_l</span><span class="o">**</span><span class="n">_r</span>

    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;pow&#39;</span>

    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">**</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span> <span class="nc">NPV_PowExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">PowExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">MaxExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maximum expressions::</span>

<span class="sd">        max(x, y, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># This operator does not have an infix representation</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;max&#39;</span>

    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">class</span> <span class="nc">NPV_MaxExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">MaxExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">MinExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimum expressions::</span>

<span class="sd">        min(x, y, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># This operator does not have an infix representation</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;min&#39;</span>

    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">class</span> <span class="nc">NPV_MinExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">MinExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<div class="viewcode-block" id="ProductExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression">[docs]</a><span class="k">class</span> <span class="nc">ProductExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Product expressions::</span>

<span class="sd">        x*y</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="ProductExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># NB: We can&#39;t use sum() here because None (non-polynomial)</span>
        <span class="c1"># overrides a numeric value (and sum() just ignores it - or</span>
        <span class="c1"># errors in py3k)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span></div>

<div class="viewcode-block" id="ProductExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;prod&#39;</span></div>

<div class="viewcode-block" id="ProductExpression._is_fixed"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression._is_fixed">[docs]</a>    <span class="k">def</span> <span class="nf">_is_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Anything times 0 equals 0, so one of the children is</span>
        <span class="c1"># fixed and has a value of 0, then this expression is fixed</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ProductExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">_l</span><span class="p">,</span> <span class="n">_r</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">_l</span> <span class="o">*</span> <span class="n">_r</span></div>

<div class="viewcode-block" id="ProductExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.ProductExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_string</span><span class="o">.</span><span class="n">one</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># TODO: remove space after negation</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_string</span><span class="o">.</span><span class="n">minus_one</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span></div>

    <span class="c1"># Store these reference sets on the function for quick lookup</span>
    <span class="n">_to_string</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;(1)&quot;</span><span class="p">,</span> <span class="s2">&quot;(1.0)&quot;</span><span class="p">}</span>
    <span class="n">_to_string</span><span class="o">.</span><span class="n">minus_one</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;(-1)&quot;</span><span class="p">,</span> <span class="s2">&quot;(-1.0)&quot;</span><span class="p">}</span></div>


<span class="k">class</span> <span class="nc">NPV_ProductExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">ProductExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">MonomialTermExpression</span><span class="p">(</span><span class="n">ProductExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;mon&#39;</span>

    <span class="k">def</span> <span class="nf">create_node_with_local_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Because monomial terms place requirements on the argument</span>
            <span class="c1"># types, the simplest / fastest thing to do is just defer to</span>
            <span class="c1"># the operator dispatcher.</span>
            <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<div class="viewcode-block" id="DivisionExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.DivisionExpression">[docs]</a><span class="k">class</span> <span class="nc">DivisionExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Division expressions::</span>

<span class="sd">        x/y</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="DivisionExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.DivisionExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DivisionExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.DivisionExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;div&#39;</span></div>

<div class="viewcode-block" id="DivisionExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.DivisionExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span></div>

<div class="viewcode-block" id="DivisionExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.DivisionExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<span class="k">class</span> <span class="nc">NPV_DivisionExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">DivisionExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<div class="viewcode-block" id="SumExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression">[docs]</a><span class="k">class</span> <span class="nc">SumExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sum expression::</span>

<span class="sd">        x + y + ...</span>

<span class="sd">    This node represents an &quot;n-ary&quot; sum expression over at least 2 arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (list): Children nodes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_nargs&#39;</span><span class="p">,)</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># unlike other expressions, we expect (require) args to be a list</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="SumExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span>

<div class="viewcode-block" id="SumExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;sum&#39;</span></div>

<div class="viewcode-block" id="SumExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="SumExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># NB: We can&#39;t use max() here because None (non-polynomial)</span>
        <span class="c1"># overrides a numeric value (and max() just ignores it)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">ans</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">ans</span></div>

<div class="viewcode-block" id="SumExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO: remove space after negation for first term</span>
        <span class="c1"># if term[0] in &#39;-+&#39;:</span>
        <span class="c1">#     values[0] = term[0] + term[1:].strip()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># TODO: remove unnecessary parenthetical grouping</span>
            <span class="c1"># (addition is the lowest priority algebraic operator, so if</span>
            <span class="c1"># a term is enclosed in parens, then it is a nested sum.)</span>
            <span class="c1"># if term[0] == &#39;(&#39; and term[-1] == &#39;)&#39; and _balanced_parens(term[1:-1]):</span>
            <span class="c1">#     term = term[1:-1]</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;-+&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">term</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;+ &#39;</span> <span class="o">+</span> <span class="n">term</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="SumExpression.add"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.SumExpression.add">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span>
        <span class="s2">&quot;SumExpression.add() is deprecated.  Please use regular Python operators &quot;</span>
        <span class="s2">&quot;(infix &#39;+&#39; or inplace &#39;+=&#39;.)&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;6.5.1.dev0&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_arg</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">+=</span> <span class="n">new_arg</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<span class="c1"># TODO: deprecate this class name</span>
<span class="n">SumExpressionBase</span> <span class="o">=</span> <span class="n">SumExpression</span>


<span class="k">class</span> <span class="nc">LinearExpression</span><span class="p">(</span><span class="n">SumExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An expression object for linear polynomials.</span>

<span class="sd">    This is a derived :py:class`SumExpression` that guarantees all</span>
<span class="sd">    arguments are either not potentially variable (e.g., native types,</span>
<span class="sd">    Params, or NPV expressions) OR :py:class:`MonomialTermExpression`</span>
<span class="sd">    objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (tuple): Children nodes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">_allowable_linear_expr_arg_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">MonomialTermExpression</span><span class="p">])</span>
    <span class="n">_cache</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear_coefs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A linear expression of the form `const + sum_i(c_i*x_i)`.</span>

<span class="sd">        You can specify `args` OR (`constant`, `linear_coefs`, and</span>
<span class="sd">        `linear_vars`).  If `args` is provided, it should be a list that</span>
<span class="sd">        contains only constants, NPV objects/expressions, or</span>
<span class="sd">        :py:class:`MonomialTermExpression` objects.  Alternatively, you</span>
<span class="sd">        can specify the constant, the list of linear_coefs and the list</span>
<span class="sd">        of linear_vars separately.  Note that these lists are NOT</span>
<span class="sd">        preserved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># I am not sure why LinearExpression allows omitting args, but</span>
        <span class="c1"># it does.  If they are provided, they should be the (non-zero)</span>
        <span class="c1"># constant followed by MonomialTermExpressions.</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">constant</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">linear_coefs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">linear_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot specify both args and any of &quot;</span>
                    <span class="s2">&quot;{constant, linear_coefs, or linear_vars}&quot;</span>
                <span class="p">)</span>
            <span class="c1"># unlike other expressions, we expect (require) args to be a list</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Filter 0, but only if it is a native type</span>
                <span class="k">if</span> <span class="n">constant</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">native_types</span> <span class="ow">or</span> <span class="n">constant</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constant</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">linear_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">linear_coefs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_coefs</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;linear_vars (</span><span class="si">{</span><span class="n">tostr</span><span class="p">(</span><span class="n">linear_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">) is not compatible &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;with linear_coefs (</span><span class="si">{</span><span class="n">tostr</span><span class="p">(</span><span class="n">linear_coefs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="n">MonomialTermExpression</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">linear_coefs</span><span class="p">,</span> <span class="n">linear_vars</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">MonomialTermExpression</span><span class="p">:</span>
                <span class="n">coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">+=</span> <span class="n">arg</span>
        <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linear_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linear_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinearExpression</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_node_with_local_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowable_linear_expr_arg_types</span><span class="p">:</span>
                <span class="c1"># 99% of the time, the arg type hasn&#39;t changed</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span><span class="p">:</span>
                <span class="c1"># native numbers are OK (that&#39;s part of the constant)</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
                <span class="c1"># NPV expressions are OK</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">():</span>
                <span class="c1"># vars are OK, but need to be mapped to monomial terms</span>
                <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For anything else, convert this to a general sum</span>
                <span class="n">classtype</span> <span class="o">=</span> <span class="n">SumExpression</span>
                <span class="k">break</span>
            <span class="c1"># We get here for new types (likely NPV types) --</span>
            <span class="c1"># remember them for when they show up again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allowable_linear_expr_arg_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_node_with_local_data</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NPV_SumExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">LinearExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">_MutableSumExpression</span><span class="p">(</span><span class="n">SumExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A mutable SumExpression</span>

<span class="sd">    The :func:`add` method is slightly different in that it</span>
<span class="sd">    does not create a new sum expression, but modifies the</span>
<span class="sd">    :attr:`_args_` data in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">make_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">SumExpression</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_iadd_mutablesum_dispatcher</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_MutableLinearExpression</span><span class="p">(</span><span class="n">_MutableSumExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">make_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">LinearExpression</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_iadd_mutablelinear_dispatcher</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_MutableNPVSumExpression</span><span class="p">(</span><span class="n">_MutableLinearExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">make_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">NPV_SumExpression</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_iadd_mutablenpvsum_dispatcher</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>


<div class="viewcode-block" id="Expr_ifExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression">[docs]</a><span class="k">class</span> <span class="nc">Expr_ifExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A numeric ternary (if-then-else) expression::</span>

<span class="sd">        Expr_if(IF=x, THEN=y, ELSE=z)</span>

<span class="sd">    Note that this is a mixed expression: `IF` can be numeric or logical;</span>
<span class="sd">    `THEN` and `ELSE` are numeric, and the result is a numeric expression.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># This operator does not have an infix representation</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># **NOTE**: This class evaluates the branching &quot;_if&quot; expression</span>
    <span class="c1">#           on a number of occasions. It is important that</span>
    <span class="c1">#           one uses __call__ for value() and NOT bool().</span>

<div class="viewcode-block" id="Expr_ifExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">3</span></div>

<div class="viewcode-block" id="Expr_ifExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Expr_if&quot;</span></div>

<div class="viewcode-block" id="Expr_ifExpression._is_fixed"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression._is_fixed">[docs]</a>    <span class="k">def</span> <span class="nf">_is_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># if.is_fixed():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># then.is_fixed()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># else.is_fixed()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Expr_ifExpression._compute_polynomial_degree"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression._compute_polynomial_degree">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_polynomial_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">_if</span><span class="p">,</span> <span class="n">_then</span><span class="p">,</span> <span class="n">_else</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">_if</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_then</span> <span class="o">==</span> <span class="n">_else</span><span class="p">:</span>
                <span class="c1"># It doesn&#39;t matter which branch is active</span>
                <span class="k">return</span> <span class="n">_then</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_then</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="n">_else</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Expr_ifExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s1">( ( </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> ), then=( </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> ), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;else=( </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> ) )&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Expr_ifExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.Expr_ifExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">_if</span><span class="p">,</span> <span class="n">_then</span><span class="p">,</span> <span class="n">_else</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">_then</span> <span class="k">if</span> <span class="n">_if</span> <span class="k">else</span> <span class="n">_else</span></div></div>


<span class="k">class</span> <span class="nc">NPV_Expr_ifExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">Expr_ifExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<div class="viewcode-block" id="UnaryFunctionExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression">[docs]</a><span class="k">class</span> <span class="nc">UnaryFunctionExpression</span><span class="p">(</span><span class="n">NumericExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An expression object for intrinsic (math) functions (e.g. sin, cos, tan).</span>

<span class="sd">    Args:</span>
<span class="sd">        args (tuple): Children nodes</span>
<span class="sd">        name (string): The function name</span>
<span class="sd">        fcn: The function that is used to evaluate this expression</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_fcn&#39;</span><span class="p">,</span> <span class="s1">&#39;_name&#39;</span><span class="p">)</span>

    <span class="c1"># This operator does not have an infix representation</span>
    <span class="n">PRECEDENCE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fcn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span> <span class="o">=</span> <span class="n">fcn</span>

<div class="viewcode-block" id="UnaryFunctionExpression.nargs"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression.nargs">[docs]</a>    <span class="k">def</span> <span class="nf">nargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="UnaryFunctionExpression.create_node_with_local_data"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression.create_node_with_local_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_node_with_local_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">return</span> <span class="n">classtype</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnaryFunctionExpression.getname"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span></div>

<div class="viewcode-block" id="UnaryFunctionExpression._to_string"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression._to_string">[docs]</a>    <span class="k">def</span> <span class="nf">_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smap</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span></div>

<div class="viewcode-block" id="UnaryFunctionExpression._apply_operation"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.UnaryFunctionExpression._apply_operation">[docs]</a>    <span class="k">def</span> <span class="nf">_apply_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="k">class</span> <span class="nc">NPV_UnaryFunctionExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">UnaryFunctionExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="c1"># NOTE: This should be a special class, since the expression generation relies</span>
<span class="c1"># on the Python __abs__ method.</span>
<div class="viewcode-block" id="AbsExpression"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.AbsExpression">[docs]</a><span class="k">class</span> <span class="nc">AbsExpression</span><span class="p">(</span><span class="n">UnaryFunctionExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An expression object for the :func:`abs` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (tuple): Children nodes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbsExpression</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">)</span>

<div class="viewcode-block" id="AbsExpression.create_node_with_local_data"><a class="viewcode-back" href="../../../../library_reference/expressions/classes.html#pyomo.core.expr.current.AbsExpression.create_node_with_local_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_node_with_local_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">classtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Because this class removes arguments from the __init__, we</span>
        <span class="c1"># also need to reimplement create_node_with_local_data to not</span>
        <span class="c1"># add those arguments here.</span>
        <span class="k">if</span> <span class="n">classtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">return</span> <span class="n">classtype</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">NPV_AbsExpression</span><span class="p">(</span><span class="n">Numeric_NPV_Mixin</span><span class="p">,</span> <span class="n">AbsExpression</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="c1"># -----------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Functions for decomposing a linear expression into linear terms</span>
<span class="c1">#</span>
<span class="c1"># -----------------------------------------------------------------</span>


<div class="viewcode-block" id="decompose_term"><a class="viewcode-back" href="../../../../library_reference/expressions/managing.html#pyomo.core.expr.current.decompose_term">[docs]</a><span class="k">def</span> <span class="nf">decompose_term</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function that returns a tuple consisting of (1) a flag indicating</span>
<span class="sd">    whether the expression is linear, and (2) a list of tuples that</span>
<span class="sd">    represents the terms in the linear expression.</span>

<span class="sd">    Args:</span>
<span class="sd">        expr (expression): The root node of an expression tree</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple with the form ``(flag, list)``.  If :attr:`flag` is</span>
<span class="sd">        :const:`False`, then a nonlinear term has been found, and</span>
<span class="sd">        :const:`list` is :const:`None`.  Otherwise, :const:`list` is a</span>
<span class="sd">        list of tuples: ``(coef, value)``.  If :attr:`value` is</span>
<span class="sd">        :const:`None`, then this represents a constant term with value</span>
<span class="sd">        :attr:`coef`.  Otherwise, :attr:`value` is a variable object,</span>
<span class="sd">        and :attr:`coef` is the numeric coefficient.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">nonpyomo_leaf_types</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[(</span><span class="n">expr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="n">expr</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_</span> <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span><span class="n">expr</span><span class="p">)]</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">terms</span>
        <span class="k">except</span> <span class="n">LinearDecompositionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>


<span class="k">class</span> <span class="nc">LinearDecompositionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_decompose_linear_terms</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A generator function that yields tuples for the linear terms</span>
<span class="sd">    in an expression.  If nonlinear terms are encountered, this function</span>
<span class="sd">    raises the :class:`LinearDecompositionError` exception.</span>

<span class="sd">    Args:</span>
<span class="sd">        expr (expression): The root node of an expression tree</span>

<span class="sd">    Yields:</span>
<span class="sd">        Tuples: ``(coef, value)``.  If :attr:`value` is :const:`None`,</span>
<span class="sd">        then this represents a constant term with value :attr:`coef`.</span>
<span class="sd">        Otherwise, :attr:`value` is a variable object, and :attr:`coef`</span>
<span class="sd">        is the numeric coefficient.</span>

<span class="sd">    Raises:</span>
<span class="sd">        :class:`LinearDecompositionError` if a nonlinear term is encountered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">expr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">():</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">multiplier</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">MonomialTermExpression</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ProductExpression</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">yield from</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">yield from</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LinearDecompositionError</span><span class="p">(</span>
                <span class="s2">&quot;Quadratic terms exist in a product expression.&quot;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">DivisionExpression</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">yield from</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">multiplier</span> <span class="o">/</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LinearDecompositionError</span><span class="p">(</span><span class="s2">&quot;Unexpected nonlinear term (division)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">SumExpression</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">NegationExpression</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">_decompose_linear_terms</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">multiplier</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LinearDecompositionError</span><span class="p">(</span><span class="s2">&quot;Unexpected nonlinear term&quot;</span><span class="p">)</span>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Functions used to generate expressions</span>
<span class="c1">#</span>
<span class="c1"># -------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">ARG_TYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MUTABLE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">ASNUMERIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">INVALID</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NATIVE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">NPV</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">PARAM</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">VAR</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">MONOMIAL</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">LINEAR</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">SUM</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">OTHER</span> <span class="o">=</span> <span class="mi">8</span>


<span class="n">_known_arg_types</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">register_arg_type</span><span class="p">(</span><span class="n">arg_class</span><span class="p">,</span> <span class="n">etype</span><span class="p">):</span>
    <span class="n">_known_arg_types</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">arg_class</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="p">(</span><span class="n">etype</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_categorize_arg_type</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">_known_arg_types</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_known_arg_types</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">native_numeric_types</span><span class="p">:</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_numeric</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_numeric_type</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_if_numeric_type</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_numeric</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;as_numeric&#39;</span><span class="p">):</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span>

    <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_expression_type</span><span class="p">():</span>
            <span class="c1"># Note: this makes a strong assumption that NPV is a class</span>
            <span class="c1"># attribute and not determined by the current expression</span>
            <span class="c1"># arguments / state.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span>
                <span class="c1"># TODO: remove NPV_expression_types</span>
                <span class="n">NPV_expression_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">_MutableSumExpression</span><span class="p">):</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">MonomialTermExpression</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">LinearExpression</span><span class="p">):</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SumExpression</span><span class="p">):</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_potentially_variable</span><span class="p">():</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">():</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span>
    <span class="n">register_arg_type</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ans</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ans</span>


<span class="k">def</span> <span class="nf">_categorize_arg_types</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_categorize_arg_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_invalid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">NotImplemented</span>


<span class="k">def</span> <span class="nf">_recast_mutable</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="n">expr</span><span class="o">.</span><span class="n">make_immutable</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">_nargs</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_unary_op_dispatcher_type_mapping</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># Special case (wrapping) operators</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">:</span> <span class="n">_asnumeric</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">:</span> <span class="n">_mutable</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">_invalid</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapping</span>


<span class="k">def</span> <span class="nf">_binary_op_dispatcher_type_mapping</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># Special case (wrapping) operators</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_any_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_asnumeric_any</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_asnumeric_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_any_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutable_any</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutable_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">):</span> <span class="n">_any_asnumeric</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>
    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="n">_asnumeric_any</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>
    <span class="n">mapping</span><span class="p">[</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">]</span> <span class="o">=</span> <span class="n">_asnumeric_asnumeric</span>

    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">):</span> <span class="n">_any_mutable</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>
    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="n">_mutable_any</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>
    <span class="n">mapping</span><span class="p">[</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mutable_mutable</span>

    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">):</span> <span class="n">_invalid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>
    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="n">_invalid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span><span class="p">})</span>

    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapping</span>


<span class="c1">#</span>
<span class="c1"># ADD: NATIVE handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_native_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">_add_native_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_native_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_native_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">_add_native_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_native_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_native_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_native_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: NPV handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_npv_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_npv_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_npv_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_npv_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">_add_npv_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_npv_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_npv_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_npv_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: PARAM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_param_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_param_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_param_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">NPV_SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_param_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">_add_param_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_param_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_param_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_param_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: VAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_var_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)),</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_var_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)),</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_var_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)),</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_var_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">(</span>
        <span class="p">[</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)),</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">))]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_var_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)),</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_var_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_var_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_var_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: MONOMIAL handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_monomial_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_monomial_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_monomial_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_monomial_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">_add_monomial_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LinearExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_monomial_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_monomial_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_monomial_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: LINEAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_linear_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_linear_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="c1">#</span>
<span class="c1"># ADD: SUM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_sum_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_sum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># ADD: OTHER handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_add_other_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_add_other_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_other_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SumExpression</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_register_new_add_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _add_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_add_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_add_type_handler_mapping</span><span class="p">[</span>
        <span class="n">types</span>
    <span class="p">]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_add_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_add_handler</span><span class="p">)</span>

<span class="n">_add_type_handler_mapping</span> <span class="o">=</span> <span class="n">_binary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_add_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_native_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_native_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_native_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_native_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_native_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_native_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_native_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_npv_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_npv_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_npv_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_npv_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_npv_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_npv_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_npv_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_param_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_param_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_param_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_param_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_param_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_param_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_param_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_var_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_var_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_var_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_var_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_var_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_var_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_var_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_var_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_monomial_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_monomial_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_monomial_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_monomial_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_monomial_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_monomial_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_monomial_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_monomial_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_linear_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_linear_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_linear_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_linear_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_linear_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_linear_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_linear_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_linear_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_sum_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_sum_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_sum_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_sum_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_sum_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_sum_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_sum_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_sum_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_add_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_add_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_add_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_add_other_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_add_other_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_add_other_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_add_other_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_add_other_other</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># MUTABLENPVSUM __iadd__ handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_iadd_mutablenpvsum_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_iadd_mutablenpvsum_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableLinearExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablelinear_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableLinearExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablelinear_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableLinearExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablelinear_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableSumExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablenpvsum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableSumExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_iadd_mutablenpvsum_type_handler_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">_invalid</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_asnumeric</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_mutable</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_native</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_npv</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_param</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_var</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_monomial</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_linear</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_sum</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_iadd_mutablenpvsum_other</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_register_new_iadd_mutablenpvsum_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _iadd_mutablenpvsum_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_iadd_mutablenpvsum_dispatcher</span><span class="p">[</span>
        <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_iadd_mutablenpvsum_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_iadd_mutablenpvsum_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_iadd_mutablenpvsum_handler</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># MUTABLELINEAR __iadd__ handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_iadd_mutablelinear_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_iadd_mutablelinear_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">nargs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableSumExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablelinear_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MutableSumExpression</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_iadd_mutablelinear_type_handler_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">_invalid</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_asnumeric</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_mutable</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_native</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_npv</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_param</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_var</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_monomial</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_linear</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_sum</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_iadd_mutablelinear_other</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_register_new_iadd_mutablelinear_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _iadd_mutablelinear_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_iadd_mutablelinear_dispatcher</span><span class="p">[</span>
        <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_iadd_mutablelinear_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_iadd_mutablelinear_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_iadd_mutablelinear_handler</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># MUTABLESUM __iadd__ handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_iadd_mutablesum_dispatcher</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">nargs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_iadd_mutablesum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="n">_iadd_mutablesum_type_handler_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">_invalid</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">:</span> <span class="n">_iadd_mutablesum_asnumeric</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">:</span> <span class="n">_iadd_mutablesum_mutable</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_iadd_mutablesum_native</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_iadd_mutablesum_npv</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_iadd_mutablesum_param</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_iadd_mutablesum_var</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_iadd_mutablesum_monomial</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_iadd_mutablesum_linear</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_iadd_mutablesum_sum</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_iadd_mutablesum_other</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_register_new_iadd_mutablesum_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _iadd_mutablesum_dispatcher dict (so this method is not called a</span>
    <span class="c1"># second time for these types)</span>
    <span class="n">_iadd_mutablesum_dispatcher</span><span class="p">[</span>
        <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_iadd_mutablesum_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_iadd_mutablesum_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_iadd_mutablesum_handler</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># NEGATION handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_neg_native</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">a</span>


<span class="k">def</span> <span class="nf">_neg_npv</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">NPV_NegationExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_neg_param</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NPV_NegationExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_neg_var</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_neg_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="o">-</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_neg_sum</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">nargs</span><span class="p">():</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># return LinearExpression([-arg for arg in a.args])</span>
    <span class="k">return</span> <span class="n">NegationExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_neg_other</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NegationExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_register_new_neg_handler</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _neg_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_neg_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_neg_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="n">_neg_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_neg_handler</span><span class="p">)</span>

<span class="n">_neg_type_handler_mapping</span> <span class="o">=</span> <span class="n">_unary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_neg_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_neg_native</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_neg_npv</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_neg_param</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_neg_var</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_neg_monomial</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_neg_sum</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_neg_sum</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_neg_other</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># MUL: NATIVE handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_native_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">_mul_native_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_native_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_native_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_native_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_mul_native_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_native_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_native_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: NPV handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_npv_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">(</span>
        <span class="p">(</span><span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_mul_npv_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_npv_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: PARAM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_param_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
    <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_mul_param_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_param_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: VAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_var_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_var_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: MONOMIAL handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_monomial_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">(</span>
        <span class="p">(</span><span class="n">NPV_ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">)),</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_mul_monomial_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_monomial_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: LINEAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_linear_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_linear_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: SUM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_sum_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_sum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># MUL: OTHER handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mul_other_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mul_other_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ProductExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_register_new_mul_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _mul_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_mul_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_mul_type_handler_mapping</span><span class="p">[</span>
        <span class="n">types</span>
    <span class="p">]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_mul_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_mul_handler</span><span class="p">)</span>

<span class="n">_mul_type_handler_mapping</span> <span class="o">=</span> <span class="n">_binary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_mul_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_native_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_native_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_native_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_native_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_native_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_native_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_native_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_npv_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_npv_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_npv_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_npv_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_npv_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_npv_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_npv_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_param_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_param_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_param_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_param_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_param_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_param_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_param_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_var_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_var_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_var_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_var_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_var_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_var_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_var_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_var_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_monomial_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_monomial_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_monomial_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_monomial_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_monomial_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_monomial_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_monomial_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_monomial_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_linear_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_linear_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_linear_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_linear_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_linear_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_linear_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_linear_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_linear_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_sum_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_sum_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_sum_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_sum_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_sum_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_sum_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_sum_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_sum_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_mul_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_mul_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_mul_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_mul_other_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_mul_other_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_mul_other_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_mul_other_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_mul_other_other</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># DIV: NATIVE handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_native_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">_div_native_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_native_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: NPV handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_npv_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_npv_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: PARAM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_param_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_param_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: VAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_var_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="n">a</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_var_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: MONOMIAL handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_monomial_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_div_monomial_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">(</span>
        <span class="p">(</span><span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">)),</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_div_monomial_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">MonomialTermExpression</span><span class="p">(</span>
        <span class="p">(</span><span class="n">NPV_DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">)),</span> <span class="n">a</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_div_monomial_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_monomial_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_monomial_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_monomial_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_monomial_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: LINEAR handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_linear_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_linear_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: SUM handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_sum_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_sum_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># DIV: OTHER handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_div_other_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_monomial</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_linear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_div_other_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DivisionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_register_new_div_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _div_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_div_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_div_type_handler_mapping</span><span class="p">[</span>
        <span class="n">types</span>
    <span class="p">]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_div_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_div_handler</span><span class="p">)</span>

<span class="n">_div_type_handler_mapping</span> <span class="o">=</span> <span class="n">_binary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_div_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_native_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_native_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_native_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_native_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_native_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_native_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_native_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_npv_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_npv_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_npv_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_npv_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_npv_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_npv_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_npv_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_param_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_param_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_param_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_param_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_param_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_param_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_param_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_var_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_var_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_var_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_var_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_var_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_var_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_var_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_var_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_monomial_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_monomial_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_monomial_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_monomial_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_monomial_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_monomial_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_monomial_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_monomial_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_linear_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_linear_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_linear_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_linear_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_linear_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_linear_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_linear_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_linear_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_sum_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_sum_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_sum_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_sum_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_sum_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_sum_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_sum_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_sum_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_div_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_div_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_div_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_div_other_var</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_div_other_monomial</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_div_other_linear</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_div_other_sum</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_div_other_other</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># POW handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_pow_native_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="n">b</span>


<span class="k">def</span> <span class="nf">_pow_native_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_native_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">**</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_native_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_npv_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_npv_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_npv_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_npv_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_param_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="n">b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_param_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_param_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
    <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">NPV_PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_param_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_other_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_other_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_other_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_zero_one_optimizations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_pow_other_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PowExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_register_new_pow_handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _pow_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_pow_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_pow_type_handler_mapping</span><span class="p">[</span>
        <span class="n">types</span>
    <span class="p">]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">_pow_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_pow_handler</span><span class="p">)</span>

<span class="n">_pow_type_handler_mapping</span> <span class="o">=</span> <span class="n">_binary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_pow_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_native_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_native_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_native_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_pow_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_pow_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_pow_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_pow_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_pow_native_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_npv_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_npv_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_npv_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_pow_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_pow_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_pow_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_pow_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_pow_npv_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_param_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_param_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_param_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">):</span> <span class="n">_pow_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">):</span> <span class="n">_pow_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span> <span class="n">_pow_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">):</span> <span class="n">_pow_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">):</span> <span class="n">_pow_param_other</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_other_param</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">):</span> <span class="n">_pow_other_native</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">):</span> <span class="n">_pow_other_npv</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span> <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">):</span> <span class="n">_pow_other_param</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">_pow_type_handler_mapping</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">_pow_other_other</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ARG_TYPE</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pow_type_handler_mapping</span>
    <span class="p">}</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># ABS handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_abs_native</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_abs_npv</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">NPV_AbsExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_abs_param</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NPV_AbsExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_abs_other</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AbsExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">_register_new_abs_handler</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _abs_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_abs_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_abs_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="n">_abs_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_abs_handler</span><span class="p">)</span>

<span class="n">_abs_type_handler_mapping</span> <span class="o">=</span> <span class="n">_unary_op_dispatcher_type_mapping</span><span class="p">(</span>
    <span class="n">_abs_dispatcher</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_abs_native</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_abs_npv</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_abs_param</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_abs_other</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_abs_other</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_abs_other</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_abs_other</span><span class="p">,</span>
        <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_abs_other</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># INTRINSIC FUNCTION handlers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_fcn_asnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_numeric</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_fcn_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_recast_mutable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_fcn_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_invalid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="n">fcn</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_native</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">fcn</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_npv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="c1"># This can be hit because of the asnumeric / mutable wrapper handlers.</span>
    <span class="k">return</span> <span class="n">NPV_UnaryFunctionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,),</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_param</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_constant</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">fcn</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NPV_UnaryFunctionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,),</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fcn_other</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UnaryFunctionExpression</span><span class="p">((</span><span class="n">a</span><span class="p">,),</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_register_new_fcn_dispatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_categorize_arg_types</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># Retrieve the appropriate handler, record it in the main</span>
    <span class="c1"># _fcn_dispatcher dict (so this method is not called a second time for</span>
    <span class="c1"># these types)</span>
    <span class="n">_fcn_dispatcher</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">_fcn_type_handler_mapping</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># Call the appropriate handler</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>


<span class="n">_fcn_dispatcher</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_register_new_fcn_dispatcher</span><span class="p">)</span>

<span class="n">_fcn_type_handler_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">ASNUMERIC</span><span class="p">:</span> <span class="n">_fcn_asnumeric</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MUTABLE</span><span class="p">:</span> <span class="n">_fcn_mutable</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">_fcn_invalid</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NATIVE</span><span class="p">:</span> <span class="n">_fcn_native</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">NPV</span><span class="p">:</span> <span class="n">_fcn_npv</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">PARAM</span><span class="p">:</span> <span class="n">_fcn_param</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span> <span class="n">_fcn_other</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">MONOMIAL</span><span class="p">:</span> <span class="n">_fcn_other</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">:</span> <span class="n">_fcn_other</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span> <span class="n">_fcn_other</span><span class="p">,</span>
    <span class="n">ARG_TYPE</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span> <span class="n">_fcn_other</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_balanced_parens</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify the string argument contains balanced parentheses.</span>

<span class="sd">    This checks that every open paren is balanced by a closed paren.</span>
<span class="sd">    That is, the infix string expression is likely to be valid.  This is</span>
<span class="sd">    primarily used to determine if a string that starts and ends with</span>
<span class="sd">    parens can have those parens removed.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; a = &quot;(( x + y ) * ( z - w ))&quot;</span>
<span class="sd">        &gt;&gt;&gt; _balanced_parens(a[1:-1])</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; a = &quot;( x + y ) * ( z - w )&quot;</span>
<span class="sd">        &gt;&gt;&gt; _balanced_parens(a[1:-1])</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_parenCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">_parenCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="n">_parenCount</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">_parenCount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">_parenCount</span> <span class="o">==</span> <span class="mi">0</span>


<span class="c1"># TODO: this is fragile (and not currently used anywhere).  It should be</span>
<span class="c1"># deprecated / removed.</span>
<span class="n">NPV_expression_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">NPV_NegationExpression</span><span class="p">,</span>
        <span class="n">NPV_ExternalFunctionExpression</span><span class="p">,</span>
        <span class="n">NPV_PowExpression</span><span class="p">,</span>
        <span class="n">NPV_MinExpression</span><span class="p">,</span>
        <span class="n">NPV_MaxExpression</span><span class="p">,</span>
        <span class="n">NPV_ProductExpression</span><span class="p">,</span>
        <span class="n">NPV_DivisionExpression</span><span class="p">,</span>
        <span class="n">NPV_SumExpression</span><span class="p">,</span>
        <span class="n">NPV_UnaryFunctionExpression</span><span class="p">,</span>
        <span class="n">NPV_AbsExpression</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2008-2023, Sandia National Laboratories.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>