name: GitHub Branch CI

on:
  push:
    branches-ignore:
      - master

defaults:
  run:
    shell: bash -l {0}

env:
  PYTHONWARNINGS: ignore::UserWarning

jobs:
  pyomo-tests:
    name: ${{ matrix.TARGET }}/py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        include:
        - os: macos-latest
          TARGET: osx
          PYENV: pip
        - os: ubuntu-latest
          TARGET: linux
          PYENV: pip
        - os: windows-latest
          TARGET: win
          PYENV: conda
        python-version: [3.7]


    steps:
    - uses: actions/checkout@v2

    # Ideally we would cache the conda downloads; however, each cache is
    # over 850MB, and with 5 python versions, that would consume 4.2 of
    # the 5 GB GitHub allows.
    #
    #- name: Conda package cache
    #  uses: actions/cache@v1
    #  if: matrix.PYENV == 'conda'
    #  id: conda-cache
    #  with:
    #    path: cache/conda
    #    key: conda-v2-${{runner.os}}-${{matrix.python-version}}

    - name: Pip package cache
      uses: actions/cache@v1
      if: matrix.PYENV == 'pip'
      id: pip-cache
      with:
        path: cache/pip
        key: pip-v2-${{runner.os}}-${{matrix.python-version}}

    - name: OS package cache
      uses: actions/cache@v1
      id: os-cache
      with:
        path: cache/os
        key: pkg-v2-${{runner.os}}

    - name: Download cache
      uses: actions/cache@v1
      id: download-cache
      with:
        path: cache/download
        key: download-v2-${{runner.os}}

    - name: TPL Package cache
      uses: actions/cache@v1
      id: tpl-cache
      with:
        path: cache/tpl
        key: tpl-v0-${{runner.os}}

    - name: Update OSX
      if: matrix.TARGET == 'osx'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/cache/os
        export HOMEBREW_CACHE=${GITHUB_WORKSPACE}/cache/os
        brew update
        # Notes:
        #  - install glpk
        #  - pyodbc needs: gcc pkg-config unixodbc freetds
        for pkg in bash gcc pkg-config unixodbc freetds glpk; do
            brew list $pkg || brew install $pkg
        done
        brew link --overwrite gcc

    - name: Update Linux
      if: matrix.TARGET == 'linux'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/cache/os
        # Notes:
        #  - install glpk
        #  - ipopt needs: libopenblas-dev gfortran liblapack-dev
        sudo apt-get -o Dir::Cache=${GITHUB_WORKSPACE}/cache/os \
            install libopenblas-dev gfortran liblapack-dev glpk-utils
        sudo chmod -R 777 ${GITHUB_WORKSPACE}/cache/os

    - name: Set up Python ${{ matrix.python-version }}
      if: matrix.PYENV == 'pip'
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Miniconda Python ${{ matrix.python-version }}
      if: matrix.PYENV == 'conda'
      uses: goanpeca/setup-miniconda@v1
      with:
        auto-update-conda: true
        python-version: ${{ matrix.python-version }}

    # GitHub actions is very fragile when it comes to setting up various
    # Python interpreters, expecially the setup-miniconda interface.
    # Per the setup-miniconda documentation, it is important to always
    # invoke bash as a login shell ('shell: bash -l {0}') so that the
    # conda environment is properly activated.  However, running within
    # a login shell appears to foul up the link to python from
    # setup-python.  Further, we have anecdotal evidence that
    # subprocesses invoked through $(python -c ...) and `python -c ...`
    # will not pick up the python activated by setup-python on OSX.
    #
    # Our solution is to define a PYTHON_EXE environment variable that
    # can be explicitly called within subprocess calls to reach the
    # correct interpreter.  Note that we must explicitly run nin a *non*
    # login shell to set up the environment variable for the
    # setup-python environments.

    - name: Install Python Packages (pip)
      if: matrix.PYENV == 'pip'
      shell: bash
      env:
        PIP_PKGS: >
            cython numpy scipy ipython openpyxl sympy pyyaml
            pyodbc networkx xlrd pandas matplotlib dill seaborn pymysql
            pyro4 pint pathos coverage nose
      run: |
        python -m pip install --cache-dir cache/pip --upgrade pip
        # Note: pandas 1.0.3 causes gams 29.1.0 import to fail in python 3.8
        pip install --cache-dir cache/pip $PIP_PKGS
        pip install --cache-dir cache/pip cplex \
            || echo "WARNING: CPLEX Community Edition is not available"
        python -c 'import sys; print("::set-env name=PYTHON_EXE::%s" \
            % (sys.executable,))'

    - name: Install Python packages (conda)
      if: matrix.PYENV == 'conda'
      env:
        CONDA_PKGS: >
            numpy scipy ipython openpyxl sympy pyodbc pyyaml networkx
            xlrd pandas matplotlib dill seaborn setuptools pip coverage
            sphinx_rtd_theme pymysql pyro4 pint pathos glpk
      run: |
        mkdir -p $GITHUB_WORKSPACE/cache/conda
        conda config --set always_yes yes
        conda config --set auto_update_conda false
        conda config --prepend pkgs_dirs $GITHUB_WORKSPACE/cache/conda
        conda info
        conda config --show-sources
        conda list --show-channel-urls
        conda install -q -y -c conda-forge --no-update-deps $CONDA_PKGS
        conda install -q -y -c ibmdecisionoptimization --no-update-deps cplex \
            || echo "WARNING: CPLEX Community Edition is not available"
        python -c 'import sys; print("::set-env name=PYTHON_EXE::%s" \
            % (sys.executable,))'

    - name: Setup TPL package directories
      run: |
        TPL_DIR="${GITHUB_WORKSPACE}/cache/tpl"
        mkdir -p "$TPL_DIR"
        DOWNLOAD_DIR="${GITHUB_WORKSPACE}/cache/download"
        mkdir -p "$DOWNLOAD_DIR"
        echo "::set-env name=TPL_DIR::$TPL_DIR"
        echo "::set-env name=DOWNLOAD_DIR::$DOWNLOAD_DIR"

    - name: Install Ipopt
      run: |
        IPOPT_DIR=$TPL_DIR/ipopt
        echo "::add-path::$IPOPT_DIR"
        if test -e $IPOPT_DIR; then
            exit 0
        fi
        echo "...downloading Ipopt"
        IPOPT_TAR=${GITHUB_WORKSPACE}/cache/download/ipopt.tar.gz
        URL=https://github.com/IDAES/idaes-ext/releases/download/2.0.0
        mkdir -p "$IPOPT_DIR"
        cd "$IPOPT_DIR"
        if test "${{matrix.TARGET}}" == osx; then
            echo "IDAES Ipopt not available on OSX"
            exit 0
        elif test "${{matrix.TARGET}}" == linux; then
            curl --retry 8 -L $URL/idaes-solvers-ubuntu1804-64.tar.gz \
                > "$IPOPT_TAR"
        else
            curl --retry 8 -L $URL/idaes-solvers-windows-64.tar.gz \
                $URL/idaes-lib-windows-64.tar.gz > "$IPOPT_TAR"
        fi
        tar -xzif $IPOPT_TAR

    - name: Install GAMS
      # We install using Powershell because the GAMS installer hangs
      # when launched from bash on Windows
      shell: pwsh
      run: |
        $GAMS_DIR="${env:TPL_DIR}/gams"
        echo "::add-path::$GAMS_DIR"
        echo "::set-env name=LD_LIBRARY_PATH::${env:LD_LIBRARY_PATH}:$GAMS_DIR"
        echo "::set-env name=DYLD_LIBRARY_PATH::${env:DYLD_LIBRARY_PATH}:$GAMS_DIR"
        if (Test-Path -Path "$GAMS_DIR") {
            exit 0
        }
        $INSTALLER="cache/download/gams_install.exe"
        $URL="https://d37drm4t2jghv5.cloudfront.net/distributions/29.1.0"
        echo "...downloading GAMS"
        if ( "${{matrix.TARGET}}" -eq "win" ) {
            $URL = "$URL/windows/windows_x64_64.exe"
        } elseif ( "${{matrix.TARGET}}" -eq "osx" ) {
            $URL = "$URL/macosx/osx_x64_64_sfx.exe"
        } else {
            $URL = "$URL/linux/linux_x64_64_sfx.exe"
        }
        Invoke-WebRequest -Uri "$URL" -OutFile "$INSTALLER"
        echo "...installing GAMS"
        if ( "${{matrix.TARGET}}" -eq "win" ) {
            Start-Process -FilePath "$INSTALLER" -ArgumentList `
                "/SP- /NORESTART /VERYSILENT /DIR=$GAMS_DIR /NOICONS" `
                -Wait
        } else {
            chmod 777 $INSTALLER
            Start-Process -FilePath "$INSTALLER" -ArgumentList `
                "-q -d $GAMS_DIR" -Wait
            mv $GAMS_DIR/*/* $GAMS_DIR/.
        }

    - name: Install GAMS Python bindings
      run: |
        GAMS_DIR="$TPL_DIR/gams"
        py_ver=$($PYTHON_EXE -c 'import sys;v="_%s%s" % sys.version_info[:2] \
            ;print(v if v != "_27" else "")')
        if test -e $GAMS_DIR/apifiles/Python/api$py_ver; then
            echo "Installing GAMS Python bindings"
            pushd $GAMS_DIR/apifiles/Python/api$py_ver
            $PYTHON_EXE setup.py install
            popd
        fi

    - name: Install BARON
      shell: pwsh
      run: |
        $BARON_DIR="${env:TPL_DIR}/baron"
        echo "::add-path::$BARON_DIR"
        if (Test-Path -Path "$BARON_DIR") {
            exit 0
        }
        $INSTALLER="cache/download/"
        $URL="https://www.minlp.com/downloads/xecs/baron/current/"
        if ( "${{matrix.TARGET}}" -eq "win" ) {
            $INSTALLER += "baron_install.exe"
            $URL += "baron-win64.exe"
        } elseif ( "${{matrix.TARGET}}" -eq "osx" ) {
            $INSTALLER += "baron_install.zip"
            $URL += "baron-osx64.zip"
        } else {
            $INSTALLER += "baron_install.zip"
            $URL += "baron-lin64.zip"
        }
        if (-not (Test-Path "$BARON_INSTALLER" -PathType Leaf)) {
            echo "...downloading BARON"
            Invoke-WebRequest -Uri "$URL" -OutFile "$INSTALLER"
        }
        echo "...installing BARON"
        if ( "${{matrix.TARGET}}" -eq "win" ) {
            Start-Process -FilePath "$INSTALLER" -ArgumentList `
                "/SP- /NORESTART /VERYSILENT /DIR=$BARON_DIR /NOICONS" `
                -Wait
        } else {
            unzip -q $INSTALLER
            mv baron-* $BARON_DIR
        }

    - name: Install GJH_ASL_JSON
      run: |
        GJH_DIR="$TPL_DIR/gjh"
        echo "::add-path::$GJH_DIR"
        if test -e "$GJH_DIR"; then
            exit 0
        fi
        URL="https://codeload.github.com/ghackebeil/gjh_asl_json/zip/master"
        wget -q "$URL" -O gjh_asl_json.zip
        unzip -q gjh_asl_json.zip
        rm -f gjh_asl_json.zip
        cd gjh_asl_json-master/Thirdparty
        ./get.ASL
        cd ..
        make
        mv $(pwd)/bin "$GJH_DIR"
        cd ..
        rm -rf gjh_asl_json-master
        echo "::add-path::$GJH_DIR"

    - name: Install Pyomo and PyUtilib
      run: |
        echo ""
        echo "Clone Pyomo-model-libraries..."
        git clone https://github.com/Pyomo/pyomo-model-libraries.git
        echo ""
        echo "Install PyUtilib..."
        echo ""
        $PYTHON_EXE -m pip install git+https://github.com/PyUtilib/pyutilib
        echo ""
        echo "Install Pyomo..."
        echo ""
        $PYTHON_EXE setup.py develop

    - name: Set up coverage tracking
      run: |
        if test "${{matrix.TARGET}}" == win; then
            COVERAGE_BASE=${GITHUB_WORKSPACE}\\.cover
        else
            COVERAGE_BASE=${GITHUB_WORKSPACE}/.cover
        fi
        COVERAGE_RC=${COVERAGE_BASE}_rc
        echo "::set-env name=COVERAGE_RCFILE::$COVERAGE_RC"
        echo "::set-env name=COVERAGE_PROCESS_START::$COVERAGE_RC"
        cp ${GITHUB_WORKSPACE}/.coveragerc ${COVERAGE_RC}
        echo "data_file=${COVERAGE_BASE}age" >> ${COVERAGE_RC}
        SITE_PACKAGES=$($PYTHON_EXE -c "from distutils.sysconfig import \
            get_python_lib; print(get_python_lib())")
        echo "Python site-packages: $SITE_PACKAGES"
        echo 'import coverage; coverage.process_startup()' \
            > ${SITE_PACKAGES}/run_coverage_at_startup.pth

    - name: Download and install extensions
      run: |
        echo ""
        echo "Pyomo download-extensions"
        echo ""
        pyomo download-extensions
        echo ""
        echo "Pyomo build-extensions"
        echo ""
        pyomo build-extensions --parallel 2

    - name: Run Pyomo tests
      run: |
        test.pyomo -v --cat="nightly" pyomo ./pyomo-model-libraries

    - name: Process code coverage report
      env:
        CODECOV_NAME: ${{matrix.TARGET}}/py${{matrix.python-version}}
      run: |
        coverage combine
        coverage report -i
        coverage xml -i
        curl --retry 8 -s https://codecov.io/bash -o codecov.sh
        # Disable coverage uploads on branches
        bash codecov.sh -X gcov -f coverage.xml
